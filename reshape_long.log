
  ___  ____  ____  ____  ____ (R)
 /__    /   ____/   /   ____/
___/   /   /___/   /   /___/   15.1   Copyright 1985-2017 StataCorp LLC
  Statistics/Data Analysis            StataCorp
                                      4905 Lakeway Drive
     Special Edition                  College Station, Texas 77845 USA
                                      800-STATA-PC        http://www.stata.com
                                      979-696-4600        stata@stata.com
                                      979-696-4601 (fax)

Single-user Stata perpetual license:
       Serial number:  401506399072
         Licensed to:  Nik Lomax
                       The University of Leeds

Notes:
      1.  Stata is running in batch mode.
      2.  Unicode is supported; see help unicode_advice.
      3.  Maximum number of variables is set to 5000; see help set_maxvar.

. do /home/ld-archer/Documents/UK_FEM/trunk/FEM_Stata/Makedata/ELSA/reshape_lon
> g.do 

. quietly include fem_env.do

. local in_file : env INPUT

. local out_file : env OUTPUT

. local scr : env SCENARIO

. *use input_data/H_ELSA.dta, clear
. use $outdata/H_ELSA.dta, clear

. global firstwave 1

. global lastwave 7 

. 
. /* Variables from Harmonized ELSA:
> 
> Section A: Demographics, Identifiers, and Weights
> Person unique ID; CoupleID number; Spouse unique ID;
> Interview status (morbidity); Stratification variable; 
> Clustering variable; Person-level cross-sectional weight; 
> Individual interview year; Individual interview month; Birth year; 
> Death year; Age at interview (years); Gender; Education (categ).
> 
> Section B: Health
> ADLs. Some difficulty:
> Walking across room; Dressing; Bathing/Shower; Eating;
> Getting in/out of bed; Using the toilet.
> 
> IADLs. Some difficulty:
> Using a map; Using a telephone; Managing money; 
> Taking Medications; Shopping for groceries;
> Preparing a hot meal; Doing work around the house or garden.
> 
> Doctor diagnosed health problems. Ever have condition:
> High blood pressure; Diabetes; Cancer; Lung Disease;
> Heart problems; Stroke; Psychological problems; 
> Arthritis.
> 
> Height, Weight, BMI:
> Height in meters; Weight in kilograms; BMI
> 
> Health Behaviours (Smoking):
> Smoke ever; Smoke now; How many cigs per day (avg).
> */
. 
. * Dropping the longitudinal sample weight (Why? Copied from Korean reshape_lo
> ng.do)
. *drop r*lwtresp (Removed as Bryan said we probably don't need to worry about 
> it)
. 
. * Keep these variables from the harmonized ELSA
. #d ;
delimiter now ;
. keep idauniq
> h*coupid
> s*idauniq
> r*iwstat
> r*strat 
> raclust
> r*cwtresp
> r*iwindy
> r*iwindm
> rabyear
> radyear
> r*agey
> ragender
> raeduc_e
> r*walkra
> r*dressa
> r*batha
> r*eata
> r*beda
> r*toilta
> r*mapa
> r*phonea
> r*moneya
> r*medsa 
> r*shopa
> r*mealsa
> r*housewka
> r*hibpe
> r*diabe 
> r*cancre 
> r*lunge
> r*hearte
> r*stroke 
> r*psyche
> r*arthre
> r*bmi 
> r*smokev
> r*smoken
> r*smokef
> ;

. #d cr
delimiter now cr
. 
. * Rename h*coupid to a more useful form
. forvalues wv = $firstwave/$lastwave {
  2.     rename h`wv'coupid r`wv'hhid
  3. }

. 
. * Rename variables to make reshape easier and have names consistent with US F
> EM
. * Respondent?
. #d ;
delimiter now ;
. foreach var in 
>     iwstat
>     strat
>     cwtresp
>     iwindy
>     iwindm
>     agey
>     walkra
>     dressa
>     batha
>     eata
>     beda
>     toilta
>     mapa
>     phonea
>     moneya
>     medsa
>     shopa
>     mealsa
>     housewka
>     hibpe
>     diabe 
>     cancre 
>     lunge
>     hearte
>     stroke 
>     psyche
>     arthre
>     bmi
>     smokev
>     smoken
>     smokef
>     hhid
>       { ;
  2.             forvalues i = $firstwave(1)$lastwave { ;
  3.                 cap confirm var r`i'`var';
  4.                 if !_rc{;
  5.                     ren r`i'`var' `var'`i';
  6.                 };
  7.             };
  8.     } ;

. #d cr
delimiter now cr
. 
. * Reshape data from wide to long
. #d ;
delimiter now ;
. reshape long iwstat strat cwtresp iwindy iwindm agey walkra dressa batha eata
>  beda 
>     toilta mapa phonea moneya medsa shopa mealsa housewka hibpe diabe cancre 
> lunge 
>     hearte stroke psyche arthre bmi smokev smoken smokef hhid 
> , i(idauniq) j(wave)
> ;
(note: j = 1 2 3 4 5 6 7)
(note: bmi1 not found)
(note: cwtresp2 not found)
(note: strat3 not found)
(note: bmi3 not found)
(note: strat4 not found)
(note: strat5 not found)
(note: bmi5 not found)
(note: strat6 not found)
(note: strat7 not found)
(note: bmi7 not found)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                    18489   ->  129423
Number of variables                 239   ->      58
j variable (7 values)                     ->   wave
xij variables:
            iwstat1 iwstat2 ... iwstat7   ->   iwstat
               strat1 strat2 ... strat7   ->   strat
         cwtresp1 cwtresp2 ... cwtresp7   ->   cwtresp
            iwindy1 iwindy2 ... iwindy7   ->   iwindy
            iwindm1 iwindm2 ... iwindm7   ->   iwindm
                  agey1 agey2 ... agey7   ->   agey
            walkra1 walkra2 ... walkra7   ->   walkra
            dressa1 dressa2 ... dressa7   ->   dressa
               batha1 batha2 ... batha7   ->   batha
                  eata1 eata2 ... eata7   ->   eata
                  beda1 beda2 ... beda7   ->   beda
            toilta1 toilta2 ... toilta7   ->   toilta
                  mapa1 mapa2 ... mapa7   ->   mapa
            phonea1 phonea2 ... phonea7   ->   phonea
            moneya1 moneya2 ... moneya7   ->   moneya
               medsa1 medsa2 ... medsa7   ->   medsa
               shopa1 shopa2 ... shopa7   ->   shopa
            mealsa1 mealsa2 ... mealsa7   ->   mealsa
      housewka1 housewka2 ... housewka7   ->   housewka
               hibpe1 hibpe2 ... hibpe7   ->   hibpe
               diabe1 diabe2 ... diabe7   ->   diabe
            cancre1 cancre2 ... cancre7   ->   cancre
               lunge1 lunge2 ... lunge7   ->   lunge
            hearte1 hearte2 ... hearte7   ->   hearte
            stroke1 stroke2 ... stroke7   ->   stroke
            psyche1 psyche2 ... psyche7   ->   psyche
            arthre1 arthre2 ... arthre7   ->   arthre
                     bmi1 bmi2 ... bmi7   ->   bmi
            smokev1 smokev2 ... smokev7   ->   smokev
            smoken1 smoken2 ... smoken7   ->   smoken
            smokef1 smokef2 ... smokef7   ->   smokef
                  hhid1 hhid2 ... hhid7   ->   hhid
-----------------------------------------------------------------------------

. #d cr
delimiter now cr
. label variable iwindy "Interview Year"

. label variable iwindm "Interview Month"

. label variable agey "Age at Interview (yrs)"

. label variable walkra "Difficulty walking across room"

. label variable dressa "Difficulty dressing"

. label variable batha "Difficulty bathing/showering"

. label variable eata "Difficulty eating"

. label variable beda "Difficulty getting in/out of bed"

. label variable toilta "Difficulty using the toilet"

. label variable mapa "Difficulty using a map"

. label variable phonea "Difficulty using a telephone"

. label variable moneya "Difficulty  managing money"

. label variable medsa "Difficulty taking medications"

. label variable shopa "Difficulty shopping for groceries"

. label variable mealsa "Difficulty preparing a hot meal"

. label variable housewka "Difficulty doing housework/gardening"

. label variable hibpe "Hypertension ever"

. label variable diabe "Diabetes ever"

. label variable cancre "Cancer ever"

. label variable lunge "Lung disease ever"

. label variable hearte "Heart disease ever"

. label variable stroke "Stroke ever"

. label variable psyche "Pyschological problems ever"

. label variable arthre "Arthritis ever"

. label variable bmi "BMI"

. label variable smokev "Smoke ever"

. label variable smoken "Smoke now"

. label variable smokef "Average cigs/day"

. label variable hhid "Household ID"

. 
. *** Recode Variables ***
. * Recode the education variable (HRS has 3 tiers of eductation, )
. recode raeduc_e (1 = 1) (3 = 2) (4/5 = 3), gen(educ)
(55524 differences between raeduc_e and educ)

. label variable educ "Education Level"

. label drop educharm

. label define educ 1 "1.Less than Secondary School" 2 "2.Graduate Secondary Sc
> hool" 3 "3.More than Secondary School"

. label values educ educ

. drop raeduc_e

. 
. * Create separate variables for hsless (less than secondary school) and colle
> ge (university)
. gen hsless = (educ == 1)

. gen college = (educ == 3)

. 
. * Label males
. gen male = (ragender == 1) if !missing(ragender)

. label variable male "Male"

. 
. * Find if dead with iwstat var
. gen died = (iwstat == 5) if !missing(iwstat)

. * Keep only those alive or recently deceased
. count
  129,423

. tab iwstat, m

                   iwstat |      Freq.     Percent        Cum.
--------------------------+-----------------------------------
                  0.inap. |     20,307       15.69       15.69
            1.resp, alive |     72,889       56.32       72.01
              4.nr, alive |      2,609        2.02       74.02
       5.nr, died this wv |      2,757        2.13       76.15
       6.nr, died prev wv |      8,177        6.32       82.47
  7.nr, dropped from samp |         25        0.02       82.49
9.nr, dk if alive or died |     22,659       17.51      100.00
--------------------------+-----------------------------------
                    Total |    129,423      100.00

. /* Dropping the 0 (inap.? Unknown code) 6 (previously deceased), 7 (dropped f
> rom sample) 
> and 9 (non-response, unkown if dead or alive) */
. keep if inlist(iwstat,1,4,5)
(51,168 observations deleted)

. count
  78,255

. 
. * FEM uses hhidpn as the person ID
. gen hhidpn = idauniq

. 
. * Year variable derived from wave (wave 1: 2002-3, wave 2: 2004-5...)
. gen year = 2000 + wave*2

. 
. * No birth month in ELSA data (unlike HRS, KLoSA) so cannot calculate exact a
> ge
. * Therefore keep agey as age variable (in years)
. 
. * Generate cross-sectional sampling weight var
. gen weight = cwtresp
(14,794 missing values generated)

. label variable weight "Cross-Sectional sampling weight"

. 
. * ADL/IADL
. egen adlcount = rowtotal(walkra dressa batha eata beda toilta)

. egen iadlcount = rowtotal(mapa phonea moneya medsa shopa mealsa housewka)

. recode adlcount (0=1) (1=2) (2=3) (3/5 = 4), gen(adlstat)
(76775 differences between adlcount and adlstat)

. recode adlcount (0=0) (1/5 = 1), gen(anyadl)
(6444 differences between adlcount and anyadl)

. recode iadlcount (0=1) (1=2) (2/5=3), gen(iadlstat)
(75441 differences between iadlcount and iadlstat)

. recode iadlcount (0=0) (1/5=1), gen(anyiadl)
(6755 differences between iadlcount and anyiadl)

. label define adlstat 1 "No ADLs" 2 "1 ADL" 3 "2 ADLs" 4 "3 or more ADLs"

. label values adlstat adlstat

. label define anyadl 0 "No ADLs" 1 "1 or more ADL" 

. label values anyadl anyadl

. label define iadlstat 1 "No IADLs" 2 "1 IADL" 3 "2 or more IADLs"

. label values iadlstat iadlstat

. label define anyiadl 0 "No IADLs" 1 "1 or more IADL" 

. label values anyiadl anyiadl

. 
. * log(bmi)
. gen logbmi = log(bmi) if !missing(bmi)
(55,075 missing values generated)

. 
. *Categorical smoking variable
. gen smkstat = 1 if smokev == 0 & smoken == 0
(51,193 missing values generated)

. replace smkstat = 2 if smokev == 1 & smoken == 0
(34,383 real changes made)

. replace smkstat = 3 if smoken == 1
(10,378 real changes made)

. label define smkstat 1 "Never smoked" 2 "Former smoker" 3 "Current smoker"

. label values smkstat smkstat

. 
. *** Generate lagged variables ***
. xtset hhidpn wave
       panel variable:  hhidpn (unbalanced)
        time variable:  wave, 1 to 7, but with gaps
                delta:  1 unit

. * Make sure that smokev is an absorbing state
. replace smokev = 1 if L.smokev == 1 & smokev == 0
(36 real changes made)

. 
. #d ;
delimiter now ;
. foreach var in
>     iwstat
>     agey
>     hibpe
>     diabe
>     cancre
>     lunge
>     hearte
>     stroke
>     psyche
>     arthre
>     bmi
>     logbmi
>     smokev
>     smoken
>     died
>     adlcount
>     adlstat
>     anyadl
>     iadlcount
>     iadlstat
>     anyiadl
>     smkstat
>     educ
>     {;
  2.         gen l2`var' = L.`var';
  3.     };
(20,655 missing values generated)
(22,794 missing values generated)
(22,806 missing values generated)
(22,806 missing values generated)
(22,806 missing values generated)
(22,806 missing values generated)
(22,806 missing values generated)
(22,806 missing values generated)
(22,806 missing values generated)
(22,807 missing values generated)
(57,130 missing values generated)
(57,130 missing values generated)
(23,303 missing values generated)
(23,353 missing values generated)
(20,655 missing values generated)
(20,655 missing values generated)
(20,655 missing values generated)
(20,655 missing values generated)
(20,655 missing values generated)
(20,655 missing values generated)
(20,655 missing values generated)
(23,470 missing values generated)
(29,030 missing values generated)

. ;
. #d cr
delimiter now cr
. 
. *** Imputation Section ***
. * Be aware of what this section is doing, particularly for missing cases!
. * We want to assess how many people are missing and being assigned mean value
>  on
. * lines 289-293
. 
. * Set lag to current if missing
. replace l2logbmi = logbmi if missing(l2logbmi) & !missing(logbmi)
(23,180 real changes made)

. 
. * Set current to lag if missing
. replace logbmi = l2logbmi if !missing(l2logbmi) & missing(logbmi)
(21,125 real changes made)

. 
. * Set to mean if still missing
. quietly sum logbmi

. replace logbmi = r(mean) if missing(logbmi)
(33,950 real changes made)

. quietly sum l2logbmi

. replace l2logbmi = r(mean) if missing(l2logbmi)
(33,950 real changes made)

. 
. * Create any_adl and any_iadl
. gen any_adl = 1 if adlcount > 0
(64,558 missing values generated)

. replace any_adl = 0 if adlcount == 0
(64,558 real changes made)

. gen any_iadl = 1 if iadlcount > 0
(63,437 missing values generated)

. replace any_iadl = 0 if iadlcount == 0
(63,437 real changes made)

. 
. gen smoke_start = 1 if l2smoken == 0 & smoken == 1
(77,755 missing values generated)

. replace smoke_start = 0 if l2smoken == 0 & smoken == 0
(43,710 real changes made)

. gen smoke_stop = 1 if l2smoken == 1 & smoken == 0
(77,058 missing values generated)

. replace smoke_stop = 0 if l2smoken == 1 & smoken == 1
(6,175 real changes made)

. gen lungecat = . /*What is this?*/
(78,255 missing values generated)

. if "`scr'" == "no_smokev" {
.     keep if smokev == 0
. }

. 
. save $outdata/reshaped_ELSA.dta, replace
(note: file /home/ld-archer/Documents/UK_FEM/trunk/input_data/reshaped_ELSA.dta
>  not found)
file /home/ld-archer/Documents/UK_FEM/trunk/input_data/reshaped_ELSA.dta saved

. 
end of do-file
