---
title: "Social_Isolation_and_Loneliness"
output: html_notebook
---

In this notebook, we prepare all the figures and tables for the paper 'Projecting the impact of loneliness and social isolation on the health outcomes of England's future elderly population'. We want to investigate how loneliness and social isolation will affect health outcomes, both together and separately, when we project an elderly population into the future using the English Future Elderly model. 

# Setup

```{r setup, include=FALSE}
# Need to set up the working directory
workingDir <- "/home/luke/Documents/E_FEM_clean/E_FEM/"
knitr::opts_knit$set(root.dir = workingDir)

require(tidyverse)
require(reactable)
require(haven)
require(ggplot2)
require(jtools)



```

## Data

```{r}
## Directories
base_output_dir <- "output/LNLY_SOCISO/"
input_dir <- "input_data/"

source('FEM_R/utilities.R')

## Inputs
long <- read_dta(paste0(input_dir, 'ELSA_long.dta'))
stock <- read_dta(paste0(input_dir, 'ELSA_stock.dta'))
repl <- read_dta(paste0(input_dir, 'ELSA_repl.dta'))
trans <- read_dta(paste0(input_dir, 'ELSA_transition.dta'))

## Outputs
### Baseline
base_full <- read_dta(paste0(base_output_dir, 'ELSA_core_base/ELSA_core_base_summary.dta'))
cohort_full <- read_dta(paste0(base_output_dir, 'ELSA_core_cohort/ELSA_core_cohort_summary.dta'))
### Interventions
no.lonely <- read_dta(paste0(base_output_dir, 'ELSA_nolnly_cohort/ELSA_nolnly_cohort_summary.dta'))
no.sociso <- read_dta(paste0(base_output_dir, 'ELSA_nosociso_cohort/ELSA_nosociso_cohort_summary.dta'))
no.lnly.sociso <- read_dta(paste0(base_output_dir, 'ELSA_nolnly_nosociso_cohort/ELSA_nolnly_nosociso_cohort_summary.dta'))
```


# Sample Statistics

In this section, we will calculate a lot of sample statistics on the stock, replenishing, and transition populations, and generate a table that can be easily copied into latex. We will also investigate the distribution of both the loneliness and social isolation measures we have added to the FEM, and particularly look to see how both loneliness and social isolation is distributed among different demographic groups. I am also interested in the individual elements of the index of social isolation, because I want to investigate some of the reasons why social isolation may be distributed differently to loneliness. 

## Sample Statistic Calculations

We want sample statistics on a number of characteristics of our input populations:
- Demographics
    - Age
    - BMI
    - Gender
    - Education
- Married/cohabiting %
- Loneliness score
- Social Isolation Index
- Risk Behaviours
    - Smoking
    - Alcohol frequency
    - Physical Activity
- Mental conditions
    - Depression
    - More?
- Chronic Diseases
    - Any
    - Hypertension
    - CVD
    - Diabetes
    - Cancer
    - Alzheimers/Dementia
    
Samples must be weighted by survey cross-sectional weight - `cwtresp`



```{r, echo=FALSE}
### Going to update the previous function from utilities.R here
# copy the data so we don't overwrite anything
s <- stock

# try it first to see what we get
#weighted.survey.means(s)

weighted.survey.means <- function(init.pop, transition=FALSE) {
  
  require(survey)
  
  if(!transition) {
    design <- svydesign(id = ~idauniq,
                        weights = ~weight,
                        data = init.pop)
  } else if(transition) {
    # Error from missing cwtresp var - drop all that are missing to solve
    init.pop <- init.pop[complete.cases(init.pop$cwtresp),]
    design <- svydesign(id = ~idauniq,
                        weights = ~cwtresp,
                        data = init.pop)
  }
  print(svymean(~age, design, na.rm=TRUE))
  print(svyvar(~age, design, na.rm=TRUE))
  print(svymean(~male, design, na.rm=TRUE))
  print(svymean(~bmi, design, na.rm=TRUE))
  print(svyvar(~bmi, design, na.rm=TRUE))
  print(svymean(~smoken, design, na.rm=TRUE))
  print(svymean(~smokev, design, na.rm=TRUE))
  print(svymean(~hsless, design, na.rm=TRUE))
  print(svymean(~college, design, na.rm=TRUE))
  print('---------------------')
  print(svymean(~cancre, design, na.rm=TRUE))
  print(svymean(~diabe, design, na.rm=TRUE))
  print(svymean(~hearte, design, na.rm=TRUE))
  print(svymean(~stroke, design, na.rm=TRUE))
  print(svymean(~lunge, design, na.rm=TRUE))
  print(svymean(~hibpe, design, na.rm=TRUE))
  print(svymean(~alzhe, design, na.rm=TRUE))
  print(svymean(~demene, design, na.rm=TRUE))
  print(svymean(~hchole, design, na.rm=TRUE))
}

s <- s %>% filter(!is.na(s$strat))

weighted.survey.means(s)

```


```{r}
## Lets try to make a table
require(survey)

# First create survey design object for weighted stats
design <- svydesign(id = ~idauniq,
                    weights = ~weight,
                    data = s)

# Now calculate means (and SE)
# Age + Sex + BMI + Smoking Status + Education MEANS
means <- svymean(~age+male+bmi+smoken+smokev+hsless+college, design, na.rm=TRUE)
mean.df <- as.data.frame(means, optional = TRUE)
mean.df <- tibble::rownames_to_column(mean.df, 'Variable')

# Need counts of non missing data per variable to calculate SD from SE
counts <- s %>% summarise_each(funs(sum(!is.na(.)))) %>%
  select(age, male, bmi, smoken, smokev, hsless, college) %>%
  t() %>%
  as.data.frame() %>%
  tibble::rownames_to_column('Variable') %>%
  rename(n = 'V1')

# Lovely, now merge
mean.df <- merge(counts, mean.df, by = 'Variable')

# Now we can calculate SD
mean.df$SD <- mean.df$SE * sqrt(mean.df$n)





print(mean.df)
```


## Distribution of Lnly
```{r}

```

## Distribution of SocIso

## Latex outputs

# Results

Looking at three outcomes in particular, and maybe some other supporting stuff if its interesting enough.

The three outcomes are:
- Life Years
- Disability-free Life Years
- Disease-free Life Years

## Functions

### Cohort

Can work out Life Years and DFLYs from summary output for cohort populations.

We do this by multiplying the number of people alive by 2 each year to get the total number of people living (life years) per wave (2 years each wave). We then get the total number of life years for all people at each wave, and can therefore work out the average life years per person by dividing the total by number of people alive at each wave.

Using these calculation we can make comparisons between baseline and intervention scenarios in terms of average life years.

```{r "LifeYears"}
# Calculate average life years for an entire cohort from 50
cohortLifeyear <- function(c) {
  c.tot.lfyrs <- c$m_endpop_all * 2
  c.sum.tot.lfyrs <- sum(c.tot.lfyrs)
  c.avg.lfyr <- c.sum.tot.lfyrs / c$m_endpop_all[1]
  return(c.avg.lfyr)
}

# Compare cohort LifeYears from 50 between two summary outputs (baseline vs int)
lifeyearComparison <- function(c, i, int.name) {
  
  c.avg.lfyr <- cohortLifeyear(c)
  
  i.avg.lfyr <- cohortLifeyear(i)
  
  print(int.name)
  print(paste('Cohort Average Lifeyears:        ', signif(c.avg.lfyr, digits=4)))
  print(paste('Intervention Average Lifeyears:  ', signif(i.avg.lfyr, digits=4)))
  print(paste('Increase:                        ', signif(x = (i.avg.lfyr - c.avg.lfyr), digits=4)))
}

# This function calculates the average number of life years in the model when diagnosed with a chronic disease
diseaseVarLifeyear <- function(c, var) {
  
  prevVar <- paste0('p_', var, '_all')
  
  c.tot.var.lfyrs <- c[,prevVar] * c$m_endpop_all * 2
  c.sum.var.lfyrs <- sum(c.tot.var.lfyrs)
  c.avg.var.lfyrs <- c.sum.var.lfyrs / c$m_endpop_all[1]
  
  print(paste0(var, ':    ', signif(c.avg.var.lfyrs, digits=4)))
}
```

```{r "Disability"}
# Calculate disability life years
disabilityLifeYearsCohort <- function(c) {
  total_dis <- c$a_disabled_all * c$m_endpop_all
  sum_tot_dis <- sum(total_dis)
  avg_dis <- sum_tot_dis / c$m_endpop_all[1]
  return(avg_dis)
}

# Compare disability life years between scenarios
disabilityLifeYearComp <- function(c, i, int.name) {
  c.avg.dis <- disabilityLifeYearsCohort(c)
  i.avg.dis <- disabilityLifeYearsCohort(i)
  print(int.name)
  print(paste('Cohort Average Disabled Lifeyears:        ', signif(c.avg.dis, digits=4)))
  print(paste('Intervention Average Disabled Lifeyears:  ', signif(i.avg.dis, digits=4)))
  print(paste('Increase:                        ', signif(x = (i.avg.dis - c.avg.dis), digits=4)))
}

# Calculate disability free life years
disabilityFreeLifeYearsCohort <- function(c) {
  total_disfree <- c$a_not_disabled_all * c$m_endpop_all
  sum_tot_disfree <- sum(total_disfree)
  avg_disfree <- sum_tot_disfree / c$m_endpop_all[1]
  return(avg_disfree)
}

# Compare disability free life years between scenarios
disabilityFreeLifeYearsComp <- function(c, i, int.name) {
  c.avg.dis <- disabilityFreeLifeYearsCohort(c)
  i.avg.dis <- disabilityFreeLifeYearsCohort(i)
  print(int.name)
  print(paste('Cohort Average Disability Free Lifeyears:        ', signif(c.avg.dis, digits=4)))
  print(paste('Intervention Average Disability Free Lifeyears:  ', signif(i.avg.dis, digits=4)))
  print(paste('Increase:                                        ', signif(x = (i.avg.dis - c.avg.dis), digits=4)))
}
```

```{r "Disease"}
# Calculate disease life years
diseaseLifeYearsCohort <- function(c) {
  total_dis <- c$a_anydisease_all * c$m_endpop_all
  sum_tot_dis <- sum(total_dis)
  avg_dis <- sum_tot_dis / c$m_endpop_all[1]
  return(avg_dis)
}

# Compare disease life years between scenarios
diseaseLifeYearComp <- function(c, i, int.name) {
  c.avg.dis <- diseaseLifeYearsCohort(c)
  i.avg.dis <- diseaseLifeYearsCohort(i)
  print(int.name)
  print(paste('Cohort Average Diseased Lifeyears:        ', signif(c.avg.dis, digits=4)))
  print(paste('Intervention Average Diseased Lifeyears:  ', signif(i.avg.dis, digits=4)))
  print(paste('Increase:                        ', signif(x = (i.avg.dis - c.avg.dis), digits=4)))
}

# Calculate disease free life years
diseaseFreeLifeYearsCohort <- function(c) {
  total_disfree <- c$a_nodisease_all * c$m_endpop_all
  sum_tot_disfree <- sum(total_disfree)
  avg_disfree <- sum_tot_disfree / c$m_endpop_all[1]
  return(avg_disfree)
}

# Compare disease free life years between scenarios
diseaseFreeLifeYearsComp <- function(c, i, int.name) {
  c.avg.dis <- diseaseFreeLifeYearsCohort(c)
  i.avg.dis <- diseaseFreeLifeYearsCohort(i)
  print(int.name)
  print(paste('Cohort Average Disease Free Lifeyears:        ', signif(c.avg.dis, digits=4)))
  print(paste('Intervention Average Disease Free Lifeyears:  ', signif(i.avg.dis, digits=4)))
  print(paste('Increase:                                        ', signif(x = (i.avg.dis - c.avg.dis), digits=4)))
}
```


### Whole Population



## Baseline

### Life Years
```{r}
coh.ly <- cohortLifeyear(cohort_full)

# Total lifeyears
print(paste('Cohort Average Lifeyears:        ', signif(coh.ly, digits=4)))

# Cohort disease life years
diseaseVarLifeyear(cohort_full, 'cancre')
diseaseVarLifeyear(cohort_full, 'diabe')
diseaseVarLifeyear(cohort_full, 'hearte')
diseaseVarLifeyear(cohort_full, 'lunge')
diseaseVarLifeyear(cohort_full, 'hibpe')
diseaseVarLifeyear(cohort_full, 'stroke')
diseaseVarLifeyear(cohort_full, 'alzhe')
diseaseVarLifeyear(cohort_full, 'demene')
```


### Disability-free Life Years

### Disease-free Life Years

## Interventions

### Burden of Loneliness
```{r}
coh.ly <- cohortLifeyear(cohort_full)
nolnly.ly <- cohortLifeyear(no.lonely)

lifeyearComparison(cohort_full, no.lonely, 'No Loneliness')
lifeyearComparison(cohort_full, no.sociso, 'No Social Isolation')
lifeyearComparison(cohort_full, no.lnly.sociso, 'No Loneliness OR Social Isolation')
```












