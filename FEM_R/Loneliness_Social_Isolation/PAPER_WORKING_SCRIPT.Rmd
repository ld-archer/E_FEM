---
title: "Social_Isolation_and_Loneliness"
output: html_notebook
---

In this notebook, we prepare all the figures and tables for the paper 'Projecting the impact of loneliness and social isolation on the health outcomes of England's future elderly population'. We want to investigate how loneliness and social isolation will affect health outcomes, both together and separately, when we project an elderly population into the future using the English Future Elderly model. 





# README!!!!!!!!!

Need some investigation as the outcomes are not what we expect:
- Check deaths by subgroup per wave
    - Make sure the underlying data shows what we expect
    - Should also extend this to see incidence of chronic disease by subgroup
- Check the indices have been created successfully
    - Loneliness should be fine, but we can test by recreating the summary measure from the three vars
    - Social isolation could be wrong. Check each member of the index for any of these weird relationships
- Look at the sample we are providing to the transition models
    - Is the sample correct? Check the paper the social isolation index is based on and see what sample they used. Maybe we can recreate this and try to recreate the results they got for their cox PH model







# Setup

```{r setup, include=FALSE}
# Need to set up the working directory
workingDir <- "/home/luke/Documents/WORK/E_FEM/E_FEM/"
knitr::opts_knit$set(root.dir = workingDir)

require(tidyverse)
require(reactable)
require(haven)
require(ggplot2)
require(jtools)
require(ggfortify)
require(survival)
require(survminer)
require(lazyeval)


```

```{r}
source('../HAZARDS/source/hazard_utils.R')
source('FEM_R/utilities.R')
```


## Data

```{r}
## Directories
base_output_dir <- "output/LNLY_SOCISO_TEST/"
input_dir <- "input_data/"

## Inputs
long <- read_dta(paste0(input_dir, 'ELSA_long.dta'))
stock <- read_dta(paste0(input_dir, 'ELSA_stock.dta'))
repl <- read_dta(paste0(input_dir, 'ELSA_repl.dta'))
trans <- read_dta(paste0(input_dir, 'ELSA_transition.dta'))

## Outputs
### Baseline
base_full <- read_dta(paste0(base_output_dir, 'ELSA_core_base/ELSA_core_base_summary.dta'))
cohort_full <- read_dta(paste0(base_output_dir, 'ELSA_core_cohort/ELSA_core_cohort_summary.dta'))
### Interventions
no.lonely <- read_dta(paste0(base_output_dir, 'ELSA_nolnly_cohort/ELSA_nolnly_cohort_summary.dta'))
no.sociso <- read_dta(paste0(base_output_dir, 'ELSA_nosociso_cohort/ELSA_nosociso_cohort_summary.dta'))
no.lnly.sociso <- read_dta(paste0(base_output_dir, 'ELSA_nolnly_nosociso_cohort/ELSA_nolnly_nosociso_cohort_summary.dta'))
```


# Sample Statistics

In this section, we will calculate a lot of sample statistics on the stock, replenishing, and transition populations, and generate a table that can be easily copied into latex. We will also investigate the distribution of both the loneliness and social isolation measures we have added to the FEM, and particularly look to see how both loneliness and social isolation is distributed among different demographic groups. I am also interested in the individual elements of the index of social isolation, because I want to investigate some of the reasons why social isolation may be distributed differently to loneliness. 

## Sample Statistic Calculations

We want sample statistics on a number of characteristics of our input populations:
- Demographics
    - Age
    - BMI
    - Gender
    - Education
- Married/cohabiting %
- Loneliness score
- Social Isolation Index
- Risk Behaviours
    - Smoking
    - Alcohol frequency
    - Physical Activity
- Mental conditions
    - Depression
    - More?
- Chronic Diseases
    - Any
    - Hypertension
    - CVD
    - Diabetes
    - Cancer
    - Alzheimers/Dementia
    
Samples must be weighted by survey cross-sectional weight - `cwtresp`



```{r, echo=FALSE}
### Going to update the previous function from utilities.R here
# copy the data so we don't overwrite anything
s <- stock

# try it first to see what we get
#weighted.survey.means(s)

weighted.survey.means <- function(init.pop, transition=FALSE) {
  
  require(survey)
  
  if(!transition) {
    design <- svydesign(id = ~idauniq,
                        weights = ~weight,
                        data = init.pop)
  } else if(transition) {
    # Error from missing cwtresp var - drop all that are missing to solve
    init.pop <- init.pop[complete.cases(init.pop$cwtresp),]
    design <- svydesign(id = ~idauniq,
                        weights = ~cwtresp,
                        data = init.pop)
  }
  print(svymean(~age, design, na.rm=TRUE))
  print(svyvar(~age, design, na.rm=TRUE))
  print(svymean(~male, design, na.rm=TRUE))
  print(svymean(~bmi, design, na.rm=TRUE))
  print(svyvar(~bmi, design, na.rm=TRUE))
  print(svymean(~smoken, design, na.rm=TRUE))
  print(svymean(~smokev, design, na.rm=TRUE))
  print(svymean(~hsless, design, na.rm=TRUE))
  print(svymean(~college, design, na.rm=TRUE))
  print('---------------------')
  print(svymean(~cancre, design, na.rm=TRUE))
  print(svymean(~diabe, design, na.rm=TRUE))
  print(svymean(~hearte, design, na.rm=TRUE))
  print(svymean(~stroke, design, na.rm=TRUE))
  print(svymean(~lunge, design, na.rm=TRUE))
  print(svymean(~hibpe, design, na.rm=TRUE))
  print(svymean(~alzhe, design, na.rm=TRUE))
  print(svymean(~demene, design, na.rm=TRUE))
  print(svymean(~hchole, design, na.rm=TRUE))
}

s <- s %>% filter(!is.na(s$strat))

weighted.survey.means(s)

```


```{r}
## Lets try to make a table
require(survey)

# First create survey design object for weighted stats
design <- svydesign(id = ~idauniq,
                    weights = ~weight,
                    data = s)

# Now calculate means (and SE)
# Age + Sex + BMI + Smoking Status + Education MEANS
means <- svymean(~age+male+bmi+smoken+smokev+hsless+college, design, na.rm=TRUE)
mean.df <- as.data.frame(means, optional = TRUE)
mean.df <- tibble::rownames_to_column(mean.df, 'Variable')

# Need counts of non missing data per variable to calculate SD from SE
counts <- s %>% summarise_each(funs(sum(!is.na(.)))) %>%
  select(age, male, bmi, smoken, smokev, hsless, college) %>%
  t() %>%
  as.data.frame() %>%
  tibble::rownames_to_column('Variable') %>%
  rename(n = 'V1')

# Lovely, now merge
mean.df <- merge(counts, mean.df, by = 'Variable')

# Now we can calculate SD
mean.df$SD <- mean.df$SE * sqrt(mean.df$n)





print(mean.df)
```


## Distribution of Lnly
```{r}

```

## Distribution of SocIso

## Latex outputs

# Survival Analysis (For Testing)

```{r}
prepped.long <- prepare_ELSA(elsa_long = long, 
                         wave_start = 1, 
                         wave_end = 9, 
                         print_counts = TRUE)
```

## Deaths
### Subgroup
```{r}
deaths_by_subgroup <- function(elsa, subgroup) {
  
  dead.subgroup <- elsa %>% 
    filter(died == 1) %>%
    group_by(sociso) %>%
    count()
  
  return(dead.subgroup)
}

test.out <- deaths_by_subgroup(prepped.long, 'sociso')
test.out

dead.subgroup <- prepped.long %>%
  filter(died == 1) %>%
  group_by(lnly) %>%
  summarise(n = n())

dead.subgroup

prepped.long %>% count(lnly)
```

```{r}
# Only extract rows when someone died
dead <- prepped.long %>% filter(died == 1)

# Report total number of deaths and number per wave
print(paste0('Number of people who died during survey: ', nrow(dead), '/', length(unique(prepped.long$idauniq))))
table(dead$wave)

dead.alcstat <- dead %>%
  group_by(wave, lnly) %>%
  count() %>%
  rename(Deaths = 'n')
# 
# # replace NA with 'unknown'
# dead.alcstat$alcstat6 <- as.character(dead.alcstat$alcstat6)
# dead.alcstat[is.na(dead.alcstat)] <- 'Unknown'
# dead.alcstat$alcstat6 <- as.factor(dead.alcstat$alcstat6)
# 
# dead.alcstat
# 
# # Now plot deaths by alcstat6 at each wave
# ggplot(data = dead.alcstat, mapping = aes(x = wave, y = Deaths, fill = alcstat6)) +
#   geom_bar(stat = 'identity', position = 'dodge') +
#   labs(title = 'Deaths stratified by alcstat6 categories',
#        x = 'Wave',
#        y = 'Number of Deaths')
# 
# ## GOOD (not really big problems but the code works fine)
# # Now calculate the proportion of each group that die each wave
# 
# # First calculate n by group at each wave (including the unknowns)
# counts.subgroup <- test %>% 
#   group_by(wave, alcstat6) %>%
#   count() %>%
#   rename(Total_sample = 'n')
# 
# # Replace NA with 'unknown'
# counts.subgroup$alcstat6 <- as.character(counts.subgroup$alcstat6)
# counts.subgroup[is.na(counts.subgroup)] <- 'Unknown'
# counts.subgroup$alcstat6 <- as.factor(counts.subgroup$alcstat6)
# 
# # now merge total and deaths together
# counts <- merge(counts.subgroup, dead.alcstat, by = c('wave', 'alcstat6'), all = TRUE)
# 
# # finally, calculate proportion of deaths per subgroup
# counts$death_prop <- (counts$Deaths / counts$Total_sample) * 100
# 
# # Now plot death_prop by alcstat6 at each wave
# ggplot(data = counts, mapping = aes(x = wave, y = death_prop, fill = alcstat6)) +
#   geom_bar(stat = 'identity', position = 'dodge') +
#   labs(title = 'Proportion of deaths per wave within alcstat6 categories',
#        x = 'Wave',
#        y = 'Percentage of Sample')
# # one more without unknown
# ggplot(data = filter(counts, alcstat6 != 'Unknown'), mapping = aes(x = wave, y = death_prop, fill = alcstat6)) +
#   geom_bar(stat = 'identity', position = 'dodge') +
#   labs(title = 'Proportion of deaths per wave within alcstat6 categories',
#        x = 'Wave',
#        y = 'Percentage of Sample')
```




# Results

Looking at three outcomes in particular, and maybe some other supporting stuff if its interesting enough.

The three outcomes are:
- Life Years
- Disability-free Life Years
- Disease-free Life Years

## Life Years Functions

### Cohort

Can work out Life Years and DFLYs from summary output for cohort populations.

We do this by multiplying the number of people alive by 2 each year to get the total number of people living (life years) per wave (2 years each wave). We then get the total number of life years for all people at each wave, and can therefore work out the average life years per person by dividing the total by number of people alive at each wave.

Using these calculation we can make comparisons between baseline and intervention scenarios in terms of average life years.

```{r "LifeYears"}
# Calculate average life years for an entire cohort from 50
cohortLifeyear <- function(c) {
  c.tot.lfyrs <- c$m_endpop_all * 2
  c.sum.tot.lfyrs <- sum(c.tot.lfyrs)
  c.avg.lfyr <- c.sum.tot.lfyrs / c$m_endpop_all[1]
  return(c.avg.lfyr)
}

# Compare cohort LifeYears from 50 between two summary outputs (baseline vs int)
lifeyearComparison <- function(c, i, int.name) {
  
  c.avg.lfyr <- cohortLifeyear(c)
  
  i.avg.lfyr <- cohortLifeyear(i)
  
  print(int.name)
  print(paste('Cohort Average Lifeyears:        ', signif(c.avg.lfyr, digits=4)))
  print(paste('Intervention Average Lifeyears:  ', signif(i.avg.lfyr, digits=4)))
  print(paste('Increase:                        ', signif(x = (i.avg.lfyr - c.avg.lfyr), digits=4)))
}

# This function calculates the average number of life years in the model when diagnosed with a chronic disease
diseaseVarLifeyear <- function(c, var) {
  
  prevVar <- paste0('p_', var, '_all')
  
  c.tot.var.lfyrs <- c[,prevVar] * c$m_endpop_all * 2
  c.sum.var.lfyrs <- sum(c.tot.var.lfyrs)
  c.avg.var.lfyrs <- c.sum.var.lfyrs / c$m_endpop_all[1]
  
  print(paste0(var, ':    ', signif(c.avg.var.lfyrs, digits=4)))
}
```

```{r "Disability"}
# Calculate disability life years
disabilityLifeYearsCohort <- function(c) {
  total_dis <- c$a_disabled_all * c$m_endpop_all
  sum_tot_dis <- sum(total_dis)
  avg_dis <- sum_tot_dis / c$m_endpop_all[1]
  return(avg_dis)
}

# Compare disability life years between scenarios
disabilityLifeYearComp <- function(c, i, int.name) {
  c.avg.dis <- disabilityLifeYearsCohort(c)
  i.avg.dis <- disabilityLifeYearsCohort(i)
  print(int.name)
  print(paste('Cohort Average Disabled Lifeyears:        ', signif(c.avg.dis, digits=4)))
  print(paste('Intervention Average Disabled Lifeyears:  ', signif(i.avg.dis, digits=4)))
  print(paste('Increase:                        ', signif(x = (i.avg.dis - c.avg.dis), digits=4)))
}

# Calculate disability free life years
disabilityFreeLifeYearsCohort <- function(c) {
  total_disfree <- c$a_not_disabled_all * c$m_endpop_all
  sum_tot_disfree <- sum(total_disfree)
  avg_disfree <- sum_tot_disfree / c$m_endpop_all[1]
  return(avg_disfree)
}

# Compare disability free life years between scenarios
disabilityFreeLifeYearsComp <- function(c, i, int.name) {
  c.avg.dis <- disabilityFreeLifeYearsCohort(c)
  i.avg.dis <- disabilityFreeLifeYearsCohort(i)
  print(int.name)
  print(paste('Cohort Average Disability Free Lifeyears:        ', signif(c.avg.dis, digits=4)))
  print(paste('Intervention Average Disability Free Lifeyears:  ', signif(i.avg.dis, digits=4)))
  print(paste('Increase:                                        ', signif(x = (i.avg.dis - c.avg.dis), digits=4)))
}
```

```{r "Disease"}
# Calculate disease life years
diseaseLifeYearsCohort <- function(c) {
  total_dis <- c$a_anydisease_all * c$m_endpop_all
  sum_tot_dis <- sum(total_dis)
  avg_dis <- sum_tot_dis / c$m_endpop_all[1]
  return(avg_dis)
}

# Compare disease life years between scenarios
diseaseLifeYearComp <- function(c, i, int.name) {
  c.avg.dis <- diseaseLifeYearsCohort(c)
  i.avg.dis <- diseaseLifeYearsCohort(i)
  print(int.name)
  print(paste('Cohort Average Diseased Lifeyears:        ', signif(c.avg.dis, digits=4)))
  print(paste('Intervention Average Diseased Lifeyears:  ', signif(i.avg.dis, digits=4)))
  print(paste('Increase:                        ', signif(x = (i.avg.dis - c.avg.dis), digits=4)))
}

# Calculate disease free life years
diseaseFreeLifeYearsCohort <- function(c) {
  total_disfree <- c$a_nodisease_all * c$m_endpop_all
  sum_tot_disfree <- sum(total_disfree)
  avg_disfree <- sum_tot_disfree / c$m_endpop_all[1]
  return(avg_disfree)
}

# Compare disease free life years between scenarios
diseaseFreeLifeYearsComp <- function(c, i, int.name) {
  c.avg.dis <- diseaseFreeLifeYearsCohort(c)
  i.avg.dis <- diseaseFreeLifeYearsCohort(i)
  print(int.name)
  print(paste('Cohort Average Disease Free Lifeyears:        ', signif(c.avg.dis, digits=4)))
  print(paste('Intervention Average Disease Free Lifeyears:  ', signif(i.avg.dis, digits=4)))
  print(paste('Increase:                                        ', signif(x = (i.avg.dis - c.avg.dis), digits=4)))
}
```


### Whole Population



## Baseline

### Life Years
```{r}
coh.ly <- cohortLifeyear(cohort_full)

# Total lifeyears
print(paste('Cohort Average Lifeyears:        ', signif(coh.ly, digits=4)))

# Cohort disease life years
diseaseVarLifeyear(cohort_full, 'cancre')
diseaseVarLifeyear(cohort_full, 'diabe')
diseaseVarLifeyear(cohort_full, 'hearte')
diseaseVarLifeyear(cohort_full, 'lunge')
diseaseVarLifeyear(cohort_full, 'hibpe')
diseaseVarLifeyear(cohort_full, 'stroke')
diseaseVarLifeyear(cohort_full, 'alzhe')
diseaseVarLifeyear(cohort_full, 'demene')
```


### Disability-free Life Years

### Disease-free Life Years

## Interventions

### Burden of Chronic Diseases

#### Life Years
```{r}
coh.ly <- cohortLifeyear(cohort_full)
nolnly.ly <- cohortLifeyear(no.lonely)

lifeyearComparison(cohort_full, no.lonely, 'No Loneliness')
lifeyearComparison(cohort_full, no.sociso, 'No Social Isolation')
lifeyearComparison(cohort_full, no.lnly.sociso, 'No Loneliness OR Social Isolation')
```

#### Disability Free Life Years
```{r}
disabilityFreeLifeYearsComp(cohort_full, no.lonely, 'No Loneliness')
disabilityFreeLifeYearsComp(cohort_full, no.sociso, 'No Social Isolation')
disabilityFreeLifeYearsComp(cohort_full, no.lnly.sociso, 'No Loneliness OR Social Isolation')
```

```{r}
diseaseFreeLifeYearsComp(cohort_full, no.lonely, 'No Loneliness')
diseaseFreeLifeYearsComp(cohort_full, no.sociso, 'No Social Isolation')
diseaseFreeLifeYearsComp(cohort_full, no.lnly.sociso, 'No Loneliness OR Social Isolation')
```










```{r}

```

