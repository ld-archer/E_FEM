---
title: "R Notebook"
output: html_notebook
---


ROUGH WORK CHECKING SCRIPT FOR LONELINESS AND SOCIAL ISOLATION WORK.


```{r setup, include=FALSE}
# Need to set up the working directory
workingDir <- "/home/luke/Documents/WORK/E_FEM/E_FEM/"
knitr::opts_knit$set(root.dir = workingDir)

require(tidyverse)
require(reactable)
require(haven)
require(ggplot2)
require(jtools)
require(ggfortify)
require(survival)
require(survminer)
require(lazyeval)


```

```{r}
source('../HAZARDS/source/hazard_utils.R')
source('FEM_R/utilities.R')
```



```{r}
## Directories
base_output_dir <- "output/LNLY_SOCISO_TEST/"
input_dir <- "input_data/"
## Inputs
long <- read_dta(paste0(input_dir, 'ELSA_long.dta'))
stock <- read_dta(paste0(input_dir, 'ELSA_stock.dta'))
repl <- read_dta(paste0(input_dir, 'ELSA_repl.dta'))
trans <- read_dta(paste0(input_dir, 'ELSA_transition.dta'))
## Outputs
### Baseline
base <- read_dta(paste0(base_output_dir, 'ELSA_core_base/ELSA_core_base_summary.dta'))
base.detail <- detailed_output_append(base.out.dir = base_output_dir, scenario = 'ELSA_core_base')
cohort <- read_dta(paste0(base_output_dir, 'ELSA_core_cohort/ELSA_core_cohort_summary.dta'))
### Cross-Validation
#cv1 <- read_dta(paste0(base_output_dir, 'ELSA_CV1/ELSA_CV1_summary.dta'))
#cv1.full <- read_dta(paste0(base_output_dir, 'ELSA_CV1/detailed_output/ELSA_CV1_summary.dta'))
#cv2 <- read_dta(paste0(base_output_dir, 'ELSA_CV2/ELSA_CV2_summary.dta'))
### Interventions
#no.lonely <- read_dta(paste0(base_output_dir, 'ELSA_nolnly_cohort/ELSA_nolnly_cohort_summary.dta'))
#no.sociso <- read_dta(paste0(base_output_dir, 'ELSA_nosociso_cohort/ELSA_nosociso_cohort_summary.dta'))
#no.lnly.sociso <- read_dta(paste0(base_output_dir, 'ELSA_nolnly_nosociso_cohort/ELSA_nolnly_nosociso_cohort_summary.dta'))
```

## LONELINESS

```{r}
lnly.test <- base.detail %>%
  select(hhidpn, year, lnly) %>%
  group_by(year, lnly) %>%
  count()

lnly.test
```

It appears that values of 0 are being assigned to lnly at some point which should not happen! First check the stock dataset and go from there.

```{r}
lnly.stock.test <- stock %>%
  select(idauniq, year, lnly) %>%
  group_by(year, lnly) %>%
  count()

lnly.stock.test

## Try the same in the long files
lnly.long.test <- long %>%
  select(idauniq, year, lnly) %>%
  filter(year == 2012) %>%
  group_by(year, lnly) %>%
  count()

lnly.long.test
```

Appears the lnly values of zero must come from these missing values, first check in stata as R loses the value labels when reading .dta files.

Stata output looking at the long file:

. keep if year == 2012
(88,070 observations deleted)

. tab lnly, m

 Loneliness |
 Score, Low |
to High [1, |
         3] |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |      5,156       44.96       44.96
          2 |      2,309       20.14       65.10
          3 |        366        3.19       68.29
          . |        866        7.55       75.84
         .c |      2,698       23.53       99.37
         .m |         72        0.63      100.00
------------+-----------------------------------
      Total |     11,467      100.00


Majority of missing cases here are due to not being in the self-completion sample. Makes sense. However what does not make sense is that kludge is not properly imputing the missing values. 

## NEW PHYSICALLY_ACTIVE

```{r}
# First long file
physact.long <- long %>% 
  select(idauniq, wave, age, male, educ, workstat, employed, inactive, retired,
         physically_active) %>%
  replace_na(list(physically_active = -9)) %>%
  group_by(wave, physically_active) %>%
  summarise(n = n(), 
            age.mean = mean(age, na.rm=TRUE),
            age.median = median(age, na.rm=TRUE),
            age.5064 = sum(age >= 50 & age < 65, na.rm=TRUE),
            age.6579 = sum(age >= 65 & age < 80, na.rm=TRUE),
            age.80p = sum(age > 79, na.rm=TRUE),
            male.prop = (sum(male, na.rm=TRUE) / n),
            female = (n - sum(male, na.rm=TRUE)),
            educ.mean = mean(educ, na.rm=TRUE),
            educ1 = sum(educ == 1, na.rm=TRUE),
            educ2 = sum(educ == 2, na.rm=TRUE),
            educ3 = sum(educ == 3, na.rm=TRUE),
            workstat.mean = mean(workstat, na.rm=TRUE),
            employed = sum(employed, na.rm=TRUE),
            inactive = sum(inactive, na.rm=TRUE),
            retired = sum(retired, na.rm=TRUE))

physact.long$wave <- as.integer(physact.long$wave)
physact.long$physically_active <- as.factor(physact.long$physically_active)
```

#### By Age

```{r}
ggplot(data = physact.long, aes(x = wave, y = n, group = physically_active, colour = physically_active)) +
  geom_line() +
  scale_x_continuous(breaks=c(1:9)) +
  labs(title = 'Number') +
  xlab('Wave') +
  ylab('Count')

ggplot(data = physact.long, aes(x = wave, y = age.mean, group = physically_active, colour = physically_active)) +
  geom_line() +
  scale_x_continuous(breaks=c(1:9)) +
  labs(title = 'Mean Age') +
  xlab('Wave') +
  ylab('Count')

age.groups <- physact.long %>% 
  select(wave, physically_active, age.5064, 
                                      age.6579, age.80p) %>%
  pivot_longer(cols = age.5064:age.80p,
               names_to = 'age_group',
               values_to = 'count')

ggplot(data = age.groups, aes(x = wave, y = count, group = physically_active, colour = physically_active)) +
  geom_line() +
  scale_x_continuous(breaks=c(1:9)) +
  facet_grid(age_group ~ .) +
  labs(title = 'Count by Age Group') +
  xlab('Wave') +
  ylab('Count')
 
# ggplot(data = physact.long, aes(x = wave, y = age.mean, group = physically_active, colour = physically_active)) +
#   geom_line() +
#   scale_x_continuous(breaks=c(1:9)) +
#   labs(title = 'Mean Age') +
#   xlab('Wave') +
#   ylab('Count')
```

#### By Sex

```{r}
ggplot(data = physact.long, aes(x = wave, y = male.prop, group = physically_active, colour = physically_active)) +
  geom_line() +
  scale_x_continuous(breaks=c(1:9)) +
  labs(title = 'Number') +
  xlab('Wave') +
  ylab('Count')
```

#### By Educ



### Job Physically Active

New variable being used to determine physically active var above. Just want to 
plot and see.

```{r}
# First long file
jphysl.long <- long %>% 
  select(idauniq, wave, age, male, educ, workstat, employed, inactive, retired,
         jphysl) %>%
  group_by(wave, jphysl) %>%
  summarise(n = n(), 
            age.mean = mean(age),
            age.median = median(age),
            age.5064 = sum(age >= 50 & age < 65),
            age.6579 = sum(age >= 65 & age < 80),
            age.80p = sum(age > 79),
            male = sum(male),
            female = (n - sum(male)),
            educ.mean = mean(educ),
            educ1 = sum(educ == 1),
            educ2 = sum(educ == 2),
            educ3 = sum(educ == 3),
            workstat.mean = mean(workstat),
            employed = sum(employed),
            inactive = sum(inactive),
            retired = sum(retired))

jphysl.long$wave <- as.integer(physact.long$wave)
```



```{r}
ggplot(data = jphysl.long, aes(x = wave, y = count)) +
  geom_line() +
  scale_x_continuous(breaks=c(1:9)) +
  labs(title = 'Workstat in ELSA') +
  xlab('Wave') +
  ylab('Count')
```


## NEW WORKSTAT

Newly recoded var is 3 levels:

- Employed
- Inactive
- Unemployed

Model won't run, saying l2inactive is not a valid variable. First thing to check
is that the variable has been properly created and check balance.

```{r}
# First long file
workstat.long <- long %>% 
  select(idauniq, wave, workstat, l2workstat, employed, 
         inactive, retired, l2employed, l2inactive, l2retired) %>%
  group_by(wave) %>%
  summarise(employed = sum(employed),
            inactive = sum(inactive),
            retired = sum(retired)) %>%
  pivot_longer(cols = employed:retired,
               names_to = 'workstat',
               values_to = 'count')

test.long$wave <- as.integer(test.long$wave)
```

```{r}
ggplot(data = workstat.long, aes(x = wave, y = count, group = workstat, color=workstat)) +
  geom_line() +
  scale_x_continuous(breaks=c(1:9)) +
  labs(title = 'Workstat in ELSA') +
  xlab('Wave') +
  ylab('Count')
```

#### Outputs

```{r}
# First long file
test.CV1 <- cv1 %>% 
  select(year, a_workstat_all, p_employed_all, 
         p_inactive_all, p_retired_all) %>%
  group_by(year) %>%
  summarise(employed = sum(p_employed_all),
            inactive = sum(p_inactive_all),
            retired = sum(p_retired_all)) %>%
  pivot_longer(cols = employed:retired,
               names_to = 'workstat',
               values_to = 'prevalence')

test.long$wave <- as.integer(test.long$wave)
```

```{r}
ggplot(data = test.CV1, aes(x = year, y = count, group = workstat, color=workstat)) +
  geom_line() +
  scale_x_continuous(breaks=c(1:9)) +
  labs(title = 'Workstat in ELSA') +
  xlab('Wave') +
  ylab('Prevalence')
```

```{r}
# First long file
test.CV1 <- long %>% 
  select(idauniq, wave, workstat, l2workstat, employed, 
         inactive, retired, l2employed, l2inactive, l2retired) %>%
  group_by(wave) %>%
  summarise(employed = sum(employed),
            inactive = sum(inactive),
            retired = sum(retired)) %>%
  pivot_longer(cols = employed:retired,
               names_to = 'workstat',
               values_to = 'count')

test.long$wave <- as.integer(test.long$wave)
```

```{r}
ggplot(data = test.long, aes(x = wave, y = count, group = workstat, color=workstat)) +
  geom_line() +
  scale_x_continuous(breaks=c(1:9)) +
  labs(title = 'Workstat in ELSA') +
  xlab('Wave') +
  ylab('Count')
```

