---
title: "FEM Transition Models"
output: html_notebook
---

```{r setup, include=FALSE}
# Need to set up the working directory
workingDir <- "/home/luke/Documents/WORK/E_FEM/E_FEM/"
knitr::opts_knit$set(root.dir = workingDir)

require(tidyverse)
require(haven)
require(MASS)

```

```{r}
source('../HAZARDS/source/hazard_utils.R')
source('FEM_R/utilities.R')
```


Load in data needed to fit these models (transition pop).

```{r}
input_dir <- "input_data/"
trans <- read_dta(paste0(input_dir, 'ELSA_transition.dta'))
long <- read_dta(paste0(input_dir, 'ELSA_long.dta'))

# make sure responses are factor where necessary
trans$died <- factor(trans$died)
trans$lnly <- factor(trans$lnly)
trans$sociso <- factor(trans$sociso)
trans$male <- factor(trans$male)
trans$hsless <- factor(trans$hsless)
trans$college <- factor(trans$college)
trans$l2employed <- factor(trans$l2employed)
trans$l2inactive <- factor(trans$l2inactive)
trans$l2physact <- factor(trans$l2physact)

# trans needs to be anything after wave 1
trans <- trans %>% 
  filter(wave > 1)

trans.notDead <- trans %>% 
  filter(died == 0)
```


# Mortality

```{r}
# Currently in the FEM (2/3/23) the mortality model only depends on demographics, loneliness, and social isolation
# This was to try and get the largest effect in mortality from interventions in these variables
# Lets try the minimal model first and go from there

# Mortality is a probit model with binary outcome


# check cross tabs with lnly and sociso
xtabs(formula = ~died + l2lnly, data = trans, addNA = TRUE)
xtabs(formula = ~died + l2sociso, data = trans, addNA = TRUE)
```

So we at least have some deaths from each group to work with. Now check the proportion of each group and see if there is a relationship between loneliness / social isolation and mortality.

```{r}
xtabs(formula = ~died + l2lnly, data = trans, addNA = TRUE)
xtabs(formula = ~died + l2sociso, data = trans, addNA = TRUE)
```

So we do have an association between the lag of loneliness and mortality.

Lets check the percentages.

```{r}
lnly <- as.data.frame(xtabs(formula = ~died + l2lnly, data = trans, addNA = TRUE))
sociso <- as.data.frame(xtabs(formula = ~died + l2sociso, data = trans, addNA = TRUE))

lnly.check <- lnly %>% 
  group_by(l2lnly) %>%
  mutate(total = sum(Freq)) %>%
  mutate(prop = (Freq / total) * 100)

sociso.check <- sociso %>% 
  group_by(l2sociso) %>%
  mutate(total = sum(Freq)) %>%
  mutate(prop = (Freq / total) * 100)

#write.csv(lnly.check, )
```

```{r}
lnly.check
```

Loneliness shows a pretty good relationship with mortality in the way that we expect. The lowest rate of mortality is in the loneliness == 1 group, which is low loneliness. Then we get higher for loneliness == 2, and higher still for loneliness == 3. Unfortunately the highest rate is in the missing group, where most people will be imputed or removed. Still happy that the relationship holds up.

```{r}
sociso.check
```

The previous output of this chunk wasn't very good, and prompted a closer look at the creation of the sociso index and the component variables. I found a problem in this definition (was a chain of replace commands that meant that the last replace was most important). Now the variable looks excellent in terms of mortality! We see the lowest rates of mortality in the sociso == 1 group (lowest / no social isolation), and higher rates of mortality as time goes on. Magnificent! 

Lets have one more go with these limited to waves 1-6, as no more deaths are recorded after wave 6.

```{r}
trans2 <- trans %>% filter(wave < 7)

lnly2 <- as.data.frame(xtabs(formula = ~died + l2lnly, data = trans2, addNA = TRUE))
sociso2 <- as.data.frame(xtabs(formula = ~died + l2sociso, data = trans2, addNA = TRUE))

lnly.check2 <- lnly2 %>%
  group_by(l2lnly) %>%
  mutate(total = sum(Freq)) %>%
  mutate(prop = (Freq / total) * 100)

sociso.check2 <- sociso2 %>%
  group_by(l2sociso) %>%
  mutate(total = sum(Freq)) %>%
  mutate(prop = (Freq / total) * 100)
```



Time to fit some models. Start with mortality, and do the minimal (just demographics), lnly/sociso, and full version.

```{r}
form.mort.min <- 'died ~ male + white + hsless + college + l2age65l + l2age6574 + l2age75p'

probit.mort.min <- glm(formula = form.mort.min, family = binomial(link = 'probit'),
                    data = trans2)

summary(probit.mort.min)
```

Now try an iteration with lnly and sociso.

```{r}
form.mort.ls <- 'died ~ male + white + hsless + college + 
                  l2age65l + l2age6574 + l2age75p + 
                  l2lnly1 + l2lnly2 + l2lnly3 +
                  l2sociso1 + l2sociso2 + l2sociso3 + l2sociso4 + l2sociso5 + l2sociso6'

probit.mort.ls <- glm(formula = form.mort.ls, family = binomial(link = 'probit'),
                    data = trans2)

summary(probit.mort.ls)
```

Interesting. Mirrors the FEM transition model, although not exactly. Same sign for each var and similar relative magnitude (i.e. in the sociso levels). The sociso relationship is great now but the loneliness is not so clear cut. This actually mirrors the literature so we could be on to something here! Try a version where the reference factors are different, might be good to pick the worst of each var and then we can see where the relationship falls down. 

```{r}
form.mort.ls2 <- 'died ~ male + white + hsless + college + 
                  l2age65l + l2age6574 + l2age75p + 
                  l2lnly1 + l2lnly2 +
                  l2sociso1 + l2sociso2 + l2sociso3 + l2sociso4 + l2sociso5'

probit.mort.ls2 <- glm(formula = form.mort.ls2, family = binomial(link = 'probit'),
                    data = trans2)

summary(probit.mort.ls2)
```

*Chefs kiss*. Exaclty what we want to see. Probability of mortality increases with higher rates of loneliness and social isolation. Appears that loneliness here is more highly associated with mortality than social isolation, but I have an idea about that. Perhaps, with loneliness being the subjective feeling and social isolation the objective situation, social isolation is more likely in people in palliative care or close to end of life already. These people are harder to follow in ELSA, and institutionalised people are removed from the survey. Maybe a contributing factor.

Try one more version, with chronic diseases and stuff.

```{r}
form.mort.full <- 'died ~ male + white + hsless + college + 
                  l2age65l + l2age6574 + l2age75p + 
                  l2lnly1 + l2lnly2 +
                  l2sociso1 + l2sociso2 + l2sociso3 + l2sociso4 + l2sociso5 +
                  l2cancre + l2diabe + l2hearte + l2alzhe + l2demene + l2lunge +
                  l2stroke'

probit.mort.full <- glm(formula = form.mort.full, family = binomial(link = 'probit'),
                    data = trans2)

summary(probit.mort.full)
```

### Test

I like the previous model, lets also do a few test versions.

```{r}
form.mort.test <- 'died ~ male + white + hsless + college + 
                  l2age65l + l2age6574 + l2age75p + 
                  l2lnly1 + l2lnly2 +
                  l2sociso1 + l2sociso2 + l2sociso3 + l2sociso4 + l2sociso5 +
                  l2cancre + l2diabe + l2hearte + l2demene + l2lunge +
                  l2stroke + l2smokev + l2smoken + l2smokef +
                  l2alcfreq1 + l2alcfreq2 + l2alcfreq3 + l2alcfreq5 + 
                  l2alcfreq6 + l2alcfreq7 + l2alcfreq8'

probit.mort.test <- glm(formula = form.mort.test, family = binomial(link = 'probit'),
                    data = trans2)

summary(probit.mort.test)
```


# Loneliness and Social Isolation

Now lets have a go at fitting models to lnly and sociso.

## Loneliness

```{r}
# Get a sample comparable to the sample used in FEM
trans.lnly <- trans %>%
  dplyr::select(idauniq, wave, died, lnly, male, white, hsless, college, l2age65l, l2age6574, l2age75p, atotb, l2employed, l2inactive, l2physact) %>%
  filter(wave > 1) %>%
  filter(died == 0)
trans.lnly.complete <- trans.lnly[complete.cases(trans.lnly),]


## MINIMAL
form.lnly.min <- 'lnly ~ male + scale(l2age65l) + scale(l2age6574) + scale(l2age75p)'
probit.lnly.min <- polr(formula = form.lnly.min,
                    data = trans.lnly,
                    Hess = TRUE,
                    na.action = na.omit)
print('Minimal model:')
summary(probit.lnly.min)

## FULL
form.lnly <- 'lnly ~ male + white + hsless + college + scale(l2age65l) + scale(l2age6574) + scale(l2age75p) + scale(atotb) + l2employed + l2inactive + l2physact'
probit.lnly <- polr(formula = form.lnly,
                    data = trans.lnly,
                    Hess = TRUE,
                    na.action = na.omit)
print('Full model:')
summary(probit.lnly)
```

Now use these models as a testbed using ideas from literature.

First up [Cohen-Mansfield et al (2015)](https://www.cambridge.org/core/journals/international-psychogeriatrics/article/abs/correlates-and-predictors-of-loneliness-in-olderadults-a-review-of-quantitative-results-informed-by-qualitative-insights/EF57448627F1EF5CFD89F83C3F188175).

Shortlist of variables I already have or can easily test:
- [x] gender
- [x] age
- [x] unmarried status
- [x] income (wealth?)
- [x] education
- nursing home resident (may be issues with 0 analysis weight) (nhmliv)
- [x] participates in social activities (socyr)
- [x] care for someone in household (R*GCAREINHH1W)
- [x] Childless (child)
- [x] living alone / few individuals in household (H*HHRES)
- [x] self reported health == poor (SRH == 1)
- [x] functional status == poor (ADL == 3+, IADL == 2+)
- [x] depression (psychiatric problems - emotional, nervous, or psychiatric)

```{r}
## TEST
form.lnly.test <- 'lnly ~ male + hsless + college + scale(l2age65l) + scale(l2age6574) + scale(l2age75p) + l2cohab + l2widowed + l2single + l2employed + l2inactive + l2physact + l2anyadl + l2anyiadl + l2srh5 + l2hhres + l2socyr + l2gcareinhh1w + childless + scale(l2logatotb) + l2cesd'
probit.lnly.test <- polr(formula = form.lnly.test,
                    data = trans,
                    Hess = TRUE,
                    na.action = na.omit)
print('Test model:')
summary(probit.lnly.test)
```

## Social Isolation

First recreate the minimal and current models before trying anything new.

```{r}
# Get a sample comparable to the sample used in FEM
trans.sociso <- trans %>%
  dplyr::select(idauniq, wave, died, sociso, male, white, hsless, college, l2age65l, l2age6574, l2age75p, atotb, l2employed, l2inactive, l2physact) %>%
  filter(wave > 1) %>%
  filter(died == 0)
trans.sociso.complete <- trans.sociso[complete.cases(trans.sociso),]


## MINIMAL
form.sociso.min <- 'sociso ~ male + scale(l2age65l) + scale(l2age6574) + scale(l2age75p)'
probit.sociso.min <- polr(formula = form.sociso.min,
                    data = trans.sociso,
                    Hess = TRUE,
                    na.action = na.omit)
# print('Minimal model:')
summary(probit.sociso.min)

## FULL
form.sociso <- 'sociso ~ male + white + hsless + college + scale(l2age65l) + scale(l2age6574) + scale(l2age75p) + scale(atotb) + l2employed + l2inactive + l2physact'
probit.sociso <- polr(formula = form.sociso,
                    data = trans.sociso,
                    Hess = TRUE,
                    na.action = na.omit)
print('Full model:')
summary(probit.sociso)
```

Now trying the predictors from the loneliness model minus some variables that would be too strongly correlated with the outcome (specifically socyr).

```{r}
## TEST
form.sociso.test <- 'sociso ~ male + hsless + college + scale(l2age65l) + scale(l2age6574) + scale(l2age75p) + l2cohab + l2widowed + l2single + l2physact + l2srh5 + l2hhres + l2gcareinhh1w + childless + scale(l2logatotb) + l2cesd + l2sight + l2hearing + l2ahown'
probit.sociso.test <- polr(formula = form.sociso.test,
                    data = trans,
                    Hess = TRUE,
                    na.action = na.omit)
print('Test model:')
summary(probit.sociso.test)
```

# Functional Limitations

Lets have a go at adlstat and iadlstat.

Data:
```{r}
trans.adlstat <- trans %>%
  dplyr::select(idauniq, wave, died, adlstat, iadlstat, male, white, hsless, 
                college, l2age65l, l2age6574, l2age75p, l2stroke, l2demene, 
                l2alzhe, l2osteoe, l2catracte, l2lnly, l2lnly1, l2lnly2, 
                l2sociso, l2cesd, l2cohab, l2widowed, l2single, l2married,
                l2alcfreq, l2smoken, l2smokef, l2smokev, l2tr20, l2verbf,
                l2orient) %>%
  filter(wave > 1) %>%
  filter(died == 0)
trans.adlstat.complete <- trans.adlstat[complete.cases(trans.adlstat),]

trans.adlstat.complete$adlstat <- as.factor(trans.adlstat.complete$adlstat)
trans.adlstat.complete$iadlstat <- as.factor(trans.adlstat.complete$iadlstat)
```

## ADLSTAT

```{r}
## MINIMAL
form.adlstat.min <- 'adlstat ~ male + scale(l2age65l) + scale(l2age6574) + scale(l2age75p)'
probit.adlstat.min <- polr(formula = form.adlstat.min,
                    data = trans.adlstat.complete,
                    Hess = TRUE,
                    na.action = na.omit)
print('Minimal model:')
summary(probit.adlstat.min)

## FULL
form.adlstat <- 'adlstat ~ male + white + hsless + college + scale(l2age65l) + scale(l2age6574) + scale(l2age75p) + l2stroke + l2demene + l2alzhe + l2osteoe + l2catracte + l2lnly + l2sociso'
probit.adlstat <- polr(formula = form.adlstat,
                    data = trans.adlstat.complete,
                    Hess = TRUE,
                    na.action = na.omit)
print('Full model:')
summary(probit.adlstat)
```

Now testing.

```{r}
## TEST
form.adlstat.test <- 'adlstat ~ male + white + hsless + college + 
scale(l2age65l) + scale(l2age6574) + scale(l2age75p) + l2stroke + l2demene + l2osteoe + l2catracte + l2lnly + l2sociso + l2cesd + l2married + 
l2widowed + l2alcfreq + l2smokev + l2tr20 + l2verbf + l2orient'
probit.adlstat.test <- polr(formula = form.adlstat.test,
                    data = trans.adlstat.complete,
                    Hess = TRUE,
                    na.action = na.omit)
print('Test model:')
summary(probit.adlstat.test)
```

AIC: 64881.53
AIC: 64857.35 : l2tr20
AIC: 57179.64 : l2verbf
AIC: 57008.17 : l2orient
AIC: 57006.91 : removed l2single

Stay there for now?

## IADLSTAT

```{r}
## MINIMAL
form.iadlstat.min <- 'iadlstat ~ male + scale(l2age65l) + scale(l2age6574) + scale(l2age75p)'
probit.iadlstat.min <- polr(formula = form.iadlstat.min,
                    data = trans.adlstat.complete,
                    Hess = TRUE,
                    na.action = na.omit)
print('Minimal model:')
summary(probit.iadlstat.min)

## FULL
form.iadlstat <- 'iadlstat ~ male + white + hsless + college + scale(l2age65l) + scale(l2age6574) + scale(l2age75p) + l2stroke + l2demene + l2alzhe + l2osteoe + l2catracte + l2lnly + l2sociso'
probit.iadlstat <- polr(formula = form.iadlstat,
                    data = trans.adlstat.complete,
                    Hess = TRUE,
                    na.action = na.omit)
print('Full model:')
summary(probit.iadlstat)
```

Now test.

```{r}
## TEST
form.iadlstat.test <- 'iadlstat ~ male + white + hsless + college + 
scale(l2age65l) + scale(l2age6574) + scale(l2age75p) + l2stroke + l2demene + l2osteoe + l2catracte + l2lnly + l2sociso + l2cesd + l2married + 
l2widowed + l2alcfreq + l2smokev + l2tr20 + l2verbf + l2orient'
probit.iadlstat.test <- polr(formula = form.iadlstat.test,
                    data = trans.adlstat.complete,
                    Hess = TRUE,
                    na.action = na.omit)
print('Test model:')
summary(probit.iadlstat.test)
```

# Cognitive Function Vars

## TR20

```{r}
## MINIMAL
form.tr20.min <- 'tr20 ~ male + scale(l2age65l) + scale(l2age6574) + scale(l2age75p)'
probit.tr20.min <- lm(formula = form.tr20.min,
                    data = trans.notDead,
                    na.action = na.omit)
print('Minimal model:')
summary(probit.tr20.min)

## TEST
form.tr20 <- 'tr20 ~ male + white + hsless + college + scale(l2age65l) + scale(l2age6574) + scale(l2age75p)'
probit.tr20 <- lm(formula = form.tr20,
                    data = trans.notDead,
                    na.action = na.omit)
print('Full model:')
summary(probit.tr20)
```

```{r}
## TEST
form.tr20.test <- 'tr20 ~ male + white + hsless + college + scale(l2age65l) + scale(l2age6574) + scale(l2age75p) + l2hearing + l2sight + l2adlstat + l2iadlstat + l2cesd + l2smoken + l2employed + l2retired'
probit.tr20.test <- lm(formula = form.tr20.test,
                    data = trans.notDead,
                    na.action = na.omit)
print('Full model:')
summary(probit.tr20.test)

# l2lnly
##  + l2physact + l2hearing + l2adlstat + l2iadlstat + l2socyr + l2cesd + l2smoken + l2smoke
```

# Sight

NOTE: Higher values of sight (self-rated eyesight) are worse. 1 == Excellent, 5 == Poor, 6 == Blind.

```{r}
trans.notDead$sight <- as.factor(trans.notDead$sight)

## MINIMAL
form.sight.min <- 'sight ~ male + scale(l2age65l) + scale(l2age6574) + scale(l2age75p)'
probit.sight.min <- polr(formula = form.sight.min,
                    data = trans.notDead,
                    Hess = TRUE,
                    na.action = na.omit)
print('Minimal model:')
summary(probit.sight.min)

## TEST
form.sight <- 'sight ~ male + white + hsless + college + scale(l2age65l) + scale(l2age6574) + scale(l2age75p) + l2catracte + l2logbmi_l30 + l2logbmi_30p + l2hchole + l2hibpe + l2alcfreq + l2smoken + l2smokev + l2stroke'
probit.sight <- polr(formula = form.sight,
                    data = trans.notDead,
                    Hess = TRUE,
                    na.action = na.omit)
print('Full model:')
summary(probit.sight)
```

AIC: 143800.44 : Initial
AIC: 128596.87 : Added alcfreq
AIC: 128133.34 : Added smoken smokev
AIC: 128039.81 : Added stroke

# Hearing

Using this paper - [Kiely et al.](https://academic.oup.com/biomedgerontology/article/67/9/997/513794?login=false).

```{r}
trans.notDead$hearing <- as.factor(trans.notDead$hearing)

## MINIMAL
form.hearing.min <- 'hearing ~ male + scale(l2age65l) + scale(l2age6574) + scale(l2age75p)'
probit.hearing.min <- polr(formula = form.hearing.min,
                    data = trans.notDead,
                    Hess = TRUE,
                    na.action = na.omit)
print('Minimal model:')
summary(probit.hearing.min)

## TEST
form.hearing <- 'hearing ~ male + white + hsless + college + scale(l2age65l) + scale(l2age6574) + scale(l2age75p) + l2logbmi_l30 + l2logbmi_30p + l2smoken + l2smokev + l2hibpe + l2diabe + l2stroke + l2sight'
probit.hearing <- polr(formula = form.hearing,
                    data = trans.notDead,
                    Hess = TRUE,
                    na.action = na.omit)
print('Full model:')
summary(probit.hearing)
```

AIC: 152711.79 : initial

```{r}

```

