---
title: "External Validation"
output: html_notebook
---


```{r setup, include=FALSE}
# Need to set up the working directory
workingDir <- "/home/luke/Documents/E_FEM_clean/E_FEM/output/COMPLETE/"
knitr::opts_knit$set(root.dir = workingDir)

require(tidyverse)
#require(reactable)
require(haven)
#require(data.table)
require(reshape2)
require(ggplot2)
#require(plyr)
require(readODS)

```

# AgeUK Almanac External Validation

'The Age UK almanac of disease profiles in later life', published in October 2015, contains information on the prevalence of major diseases, conditions, and syndromes affecting older people in England, broken down by age and sex. 


```{r}
# Just read in the data in this chunk, then don't have to have everything in the environment all the time
#AgeUK
mAGE_UK <- read.csv('../../../Validation/AgeUK-chronDisease-MALE.csv')
fAGE_UK <- read.csv('../../../Validation/AgeUK-chronDisease-FEMALE.csv')

# FEM 2014 detailed output
#FEM_2014 <- read_dta('ELSA_Baseline/detailed_output/y2014_rep1.dta')
## extract males and females
#mFEM_2014 <- FEM_2014 %>% filter(male == 1)
#fFEM_2014 <- FEM_2014 %>% filter(male == 0)

# FEM 2014 summary
FEM_sum <- read_dta('ELSA_AgeUK_core_valid/ELSA_AgeUK_core_valid_summary.dta')

```


```{r}
# Take copy of FEM summary
FEM <- FEM_sum

# Keep only year 2014 from FEM summary
FEM <- filter(FEM, year == 2014)

# Specify the age groups to extract from FEM
ages <- c('6064', '6569', '7074', '7579', '8084', '8589', '9094', '9599', '100p')
# Add m and f for male and female variables
m_ages <- paste0('m_', ages)
f_ages <- paste0('f_', ages)

# Collect the age suffixes into a vector
keep_vars <- c(m_ages, f_ages)
# Now set up the chronic diseases in a list so we can create a bigger list with all of them produced
diseases <- c('hearte', 'hibpe', 'stroke', 'diabe', 'lunge', 'cancre', 'demene', 'asthmae')

# Don't like using loops but this one was just too simple to bother with figuring out the apply version
final <- c()
ticker <- 1
# Generating the column (variable) names we want to keep in a loop
for(item in diseases) {
  for(anotherItem in keep_vars) {
    final[ticker] <- paste0('p_', item, '_', anotherItem)
    ticker <- ticker + 1
  }
}

# Keep the right vars using varnames generated in loop
FEM <- FEM %>%
          select(c('year', all_of(final)))

# Rename some vars to remove 'p_' before merging
FEM <- FEM %>%
          rename_at(vars(starts_with('p_')),
                    funs(str_replace(., 'p_', ''))) %>%
          select(!year)

pivoted.FEM <- pivot_longer(data = FEM,
                            cols = hearte_m_6064:asthmae_f_100p, 
                            names_to = c('Condition', 'Gender', 'Age_Group'), 
                            names_sep = '_')

# Convert value from fraction to percentage
pivoted.FEM$value <- pivoted.FEM$value * 100

```

Now process the AgeUK data and combine male and female

```{r}
# Copy over age uk data
male_au <- mAGE_UK
female_au <- fAGE_UK

# Rename cols to enable reshaping
male_au <- male_au %>%
                dplyr::rename(m_6064 = X60.64, m_6569 = X65.69, m_7074 = X70.74, 
                       m_7579 = X75.79, m_8084 = X80.84, m_8589 = X85.89, 
                       m_9094 = X90.94, m_9599 = X95.99, m_100p = Over.100) %>%
                select(!Total)

female_au <- female_au %>%
                dplyr::rename(f_6064 = X60.64, f_6569 = X65.69, f_7074 = X70.74, 
                       f_7579 = X75.79, f_8084 = X80.84, f_8589 = X85.89, 
                       f_9094 = X90.94, f_9599 = X95.99, f_100p = Over.100) %>%
                select(!Total)

# Now need to reshape these datasets to long format
pivoted.male <- pivot_longer(data = male_au,
                             cols = m_6064:m_100p,
                             names_to = c('Gender', 'Age_Group'),
                             names_sep = '_')

pivoted.female <- pivot_longer(data = female_au,
                             cols = f_6064:f_100p,
                             names_to = c('Gender', 'Age_Group'),
                             names_sep = '_')

# Now row bind these frames together, combining male and female data
ageUK <-rbind(pivoted.male, pivoted.female)

# Now need to deal with the fact that ageUK data splits heart issues into 3 different conditions
# extract all heart related conditions for combining
ageUK_heart <- filter(ageUK, Condition == c('Coronary Heart Disease', 'Heart Failure', 'Atrial Fibrillation'))
# Aggregate the values by gender and age group
ageUK_heart <- aggregate(ageUK_heart$value, by = list(ageUK_heart$Gender, ageUK_heart$Age_Group), FUN = sum)
# Rename columns and add condition column back
colnames(ageUK_heart) <- c('Gender', 'Age_Group', 'value')
ageUK_heart$Condition <- 'Heart Problems'

# Now drop the heart problems from original ageUK and replace with aggregate
ageUK <- filter(ageUK, Condition != 'Coronary Heart Disease', Condition != 'Heart Failure', Condition != 'Atrial Fibrillation')
ageUK <- rbind(ageUK, ageUK_heart)

# Rename a few just for completeness
ageUK$Condition <- gsub("Cancer, recent", "Cancer", ageUK$Condition)
ageUK$Condition <- gsub("COPD", "Lung Disease (COPD)", ageUK$Condition)

# Finally, add column to specify that this is ageUK data
ageUK$source <- "ageUK"

# REMOVE CONDITIONS FROM ageUK THAT ARE NOT IN FEM (may change in future)
#ageUK <- filter(ageUK, Condition != c('Asthma', 'Depression', 'Severe Mental Health Condition'))
ageUK <- filter(ageUK, Condition != 'Depression', Condition != 'Severe Mental Health Conditions')

```

```{r}

# COME ON!!!!!!
# Steps:
#   - Rename FEM rows to match AgeUK
#   - Add column to specify between FEM and AgeUK
#   - Merge datasets, maintain long format
#   - ggplot2 some nice grouped bar charts
#   - Also think about some nice reactable tables maybe? With some custom styling

# Make copy
newFEM <- pivoted.FEM

# Rename all the conditions to fit ageUK
# NOTE: Lung disease is not a perfect match, as ageUK only contains info on COPD
#       Therefore only validation from this will be that FEM is higher than ageUK
newFEM$Condition <- gsub("hearte", "Heart Problems", newFEM$Condition)
newFEM$Condition <- gsub("hibpe", "Hypertension", newFEM$Condition)
newFEM$Condition <- gsub("stroke", "Stroke", newFEM$Condition)
newFEM$Condition <- gsub("diabe", "Diabetes", newFEM$Condition)
newFEM$Condition <- gsub("lunge", "Lung Disease (COPD)", newFEM$Condition)
newFEM$Condition <- gsub("cancre", "Cancer", newFEM$Condition)
newFEM$Condition <- gsub("demene", "Dementia", newFEM$Condition)
newFEM$Condition <- gsub("asthmae", "Asthma", newFEM$Condition)

# Add column to specify this is FEM data
newFEM$source <- "FEM"

```

```{r}

# Now row bind the datasets
combined <- rbind(newFEM, ageUK)
# Specify factor levels for age group
combined$Age_Group <- factor(combined$Age_Group, levels = c('6064', '6569', '7074', '7579', '8084', '8589', '9094', '9599', '100p'))
# Sort
combined <- arrange(combined, source, Condition, Gender, Age_Group)

```


```{r}

# Lets do some plotting!

# First try to plot the whole dataset in a facet grid
# This isn't perfect, and it's pretty complicated to plot altogether
ggplot(data = combined, aes(x = Age_Group, y = value, width = 0.7)) +
  geom_bar(aes(fill = source), stat = "identity", position = "dodge") +
  facet_wrap(~Condition)


```

```{r}

# Now instead, lets plot an individual condition - Hypertension

# First extract all hypertension info
hyper <- filter(combined, Condition == 'Hypertension')

# Big dirty plot
ggplot(data = hyper, aes(x = Age_Group, y = value, width = 0.7)) +
  geom_bar(aes(fill = source), stat = "identity", position = "dodge") +
  labs(title = 'Hypertension', x = 'Age Group', y = 'Proportion')


```

```{r}

# Next, lets try an all female and all male example
comb <- combined

# extract genders
male <- filter(combined, Gender == 'm')
female <- filter(combined, Gender == 'f')

# try plotting each separately

ggplot(data = male, aes(x = Age_Group, y = value, width = 0.7)) +
  geom_bar(aes(fill = source), stat = "identity", position = "dodge") +
  facet_wrap(~Condition) +
  labs(title = 'Male')

ggplot(data = female, aes(x = Age_Group, y = value, width = 0.7)) +
  geom_bar(aes(fill = source), stat = "identity", position = "dodge") +
  facet_wrap(~Condition) +
  labs(title = 'Female')

```

```{r}

# Function to filter the combined dataset and visualise
visAgeUKValid <- function(data, cd, gender, path = '/home/luke/Documents/E_FEM_clean/Deliverables/E-FEM_Paper/figures/Validation/ageUK/') {
  
  if(gender == 'm') {
    full_gender <- 'Male'
  }
  else if(gender == 'f') {
    full_gender <- 'Female'
  }
  
  # filter by gender and condition
  data <- data %>%
            filter(Gender == gender) %>%
            filter(Condition == cd)
  
  # now plot!
  p <- ggplot(data = data, aes(x = Age_Group, y = value)) +
          geom_bar(aes(fill = source), stat = "identity", position = "dodge") +
          labs(title = paste(cd, full_gender, sep = ' '), x = 'Age Group', y = 'Proportion')
  
  # Save plot into in E-FEM_Paper/figures/
  #ggsave(filename = paste0(cd, '_', gender, '.png'),
  #       plot = p,
  #       path = path,
  #       width = 7,
  #       height = 5)
  
  return(p)
}

visAgeUKValid(combined, 'Hypertension', 'm')

```

```{r}

# Collect all conditions (and both genders) into a list, and apply the function above to that list
cd_list <- unique(combined$Condition)
gender_list <- unique(combined$Gender)

for(cd in cd_list) {
  for(gen in gender_list) {
    plot <- visAgeUKValid(combined, cd, gen)
    print(plot)
  }
}


```

## With Error Bars
```{r}
# Function to filter the combined dataset and visualise
visAgeUKValidError <- function(data, cd, gender, path = '/home/luke/Documents/E_FEM_clean/Deliverables/E-FEM_Paper/figures/Validation/ageUK/') {
  
  if(gender == 'm') {
    full_gender <- 'Male'
  }
  else if(gender == 'f') {
    full_gender <- 'Female'
  }
  
  # filter by gender and condition
  data <- data %>%
            filter(Gender == gender) %>%
            filter(Condition == cd)
  
  # now plot!
  p <- ggplot(data = data, aes(x = Age_Group, y = value)) +
          geom_bar(aes(fill = source), stat = "identity", position = "dodge") +
          labs(title = paste(cd, full_gender, sep = ' '), x = 'Age Group', y = 'Proportion')
  
  # Save plot into in E-FEM_Paper/figures/
  #ggsave(filename = paste0(cd, '_', gender, '.png'),
  #       plot = p,
  #       path = path,
  #       width = 7,
  #       height = 5)
  
  return(p)
}

visAgeUKValid(combined, 'Hypertension', 'm')
```



# Smoking

## Action on Smoking and Health

```{r}
FEM_base <- read_dta('ELSA_Baseline/ELSA_Baseline_summary.dta')

# Smoking prevalence stats
# Stats found here: https://ash.org.uk/information-and-resources/fact-sheets/smoking-statistics-who-smokes-and-how-much/
# Page 3, table 4
smok.5059 <- 15.2
smok.60p <- 10.2

# FEM summary, filter for 2018 and 60p
#FEM.smok <- FEM_sum
FEM.smok <- FEM_base
FEM.smok <- FEM.smok %>%
                filter(year == 2018) %>%
                select(contains('smoken')) %>%
                select(contains('60p'), contains('5059')) %>%
                select(contains('p_'))

FEM.smok <- FEM.smok * 100

smok.combined <- data.frame(FEM = FEM.smok[1,1], AgeUK = 10.2)
smok.combined <- data.frame(source = c('FEM', 'FEM', 'Observed', 'Observed'), age = c('50 - 59', '60+', '50 - 59', '60+'), value = c(FEM.smok[1,2], FEM.smok[1,1], 15.2, 10.2))

smok.plot <-ggplot(data = smok.combined, aes(x = age, y = value)) +
                geom_bar(aes(fill = source), stat = "identity", position = "dodge") +
                labs(title = 'Comparison of smoking prevalence in the elderly in 2018', x = ' ', y = 'Prevalence (%)')

ggsave(filename = 'smoking_prev_2018.png',
       plot = smok.plot,
       path = '/home/luke/Documents/E_FEM_clean/Deliverables/E-FEM_Paper/figures/Validation/',
       width = 7,
       height = 5)

smok.plot

```

## ONS

Found some more data on smoking in the UK from the ONS, perhaps more reliable than the other? Might be a good idea to show both if they are all within a couple of percent.

```{r}
# FEM
FEM_base <- read_dta('ELSA_Baseline/ELSA_Baseline_summary.dta')

# ONS - Male
m.ons.smok <- read_ods(path = '/home/luke/Documents/E_FEM_clean/Validation/adultsmokinghabitsinengland2019final.ods',
                sheet = 4,
                skip = 8,
                col_names = TRUE,
                row_names = FALSE,
                range = "E1:F22")
# ONS - Female
f.ons.smok <- read_ods(path = '/home/luke/Documents/E_FEM_clean/Validation/adultsmokinghabitsinengland2019final.ods',
                sheet = 4,
                skip = 8,
                col_names = TRUE,
                row_names = FALSE,
                range = "L1:M22")
# ONS - All
all.ons.smok <- read_ods(path = '/home/luke/Documents/E_FEM_clean/Validation/adultsmokinghabitsinengland2019final.ods',
                sheet = 4,
                skip = 8,
                col_names = TRUE,
                row_names = FALSE,
                range = "S1:T22")

# Remove empty row
m.ons.smok <- m.ons.smok %>% slice(-1)
f.ons.smok <- f.ons.smok %>% slice(-1)
all.ons.smok <- all.ons.smok %>% slice(-1)

# Add year column
m.ons.smok$Year <- c(2000:2019)
f.ons.smok$Year <- c(2000:2019)
all.ons.smok$Year <- c(2000:2019)

# Add Gender col
m.ons.smok$Gender <- 'Male'
f.ons.smok$Gender <- 'Female'
all.ons.smok$Gender <- 'All'

# Rearrange columns before rbind
m.ons.smok <- subset(m.ons.smok, select = c(3,4,1,2))
f.ons.smok <- subset(f.ons.smok, select = c(3,4,1,2))
all.ons.smok <- subset(all.ons.smok, select = c(3,4,1,2))

# Filter out years before 2012
m.ons.smok <- dplyr::filter(m.ons.smok, Year >= 2012)
f.ons.smok <- dplyr::filter(f.ons.smok, Year >= 2012)
all.ons.smok <- dplyr::filter(all.ons.smok, Year >= 2012)

# Combine male, female, all and rename 60 plus column
ons.smok <- rbind(m.ons.smok, f.ons.smok, all.ons.smok)
ons.smok <- dplyr::rename(ons.smok, '60p' = '60 and over')

# Reshape data to long
pivot.ons.smok <- pivot_longer(data = ons.smok,
                               cols = '50-59':'60p',
                               names_to = 'Age',
                               values_to = 'Value')

pivot.ons.smok$Source <- 'ONS'


# ONS data wrangled, now get FEM into shape
FEM.smok <- FEM_base
# Get year out to put back later
Year <- FEM.smok$year
FEM.smok <- FEM.smok %>%
                select(contains('smoken')) %>%
                select(contains('p_'), -starts_with('n_')) %>%
                select(contains('60p'), contains('5059')) %>%
                dplyr::rename('60p' = p_smoken_60p, '50-59' = p_smoken_5059)

FEM.smok <- subset(FEM.smok, select = c(2, 1))
FEM.smok <- cbind(Year, FEM.smok)

FEM.smok <- filter(FEM.smok, year >= 2012, year < 2022)

pivot.FEM.smok <- pivot_longer(data = FEM.smok,
                               cols = '50-59':'60p',
                               names_to = 'Age',
                               values_to = 'Value')
pivot.FEM.smok$Source <- 'FEM'
pivot.FEM.smok$Value <- pivot.FEM.smok$Value * 100

pivot.ons.smok.all <- pivot.ons.smok %>%
                          filter(Gender == 'All') %>%
                          select(-Gender)
  
combined <- rbind(pivot.FEM.smok, pivot.ons.smok.all)

ggplot(data = combined, aes(x = Year, y = Value)) +
  geom_bar(aes(fill = Source), stat = 'identity', position = 'dodge')


```


# ADLs

Just having a play around with this data, wanted to visualise how levels of anyADL change over time.

```{r}

FEM.new <- FEM_base

FEM.adl <- FEM.new %>%
              select(contains('year'), contains('anyadl')) %>%
              select(-starts_with('i_'), -starts_with('n_'), -starts_with('a_')) %>%
              select(-contains('_m'), -contains('_f')) %>%
              select(-contains('5059'), -contains('60p'))

p.FEM.adl <- pivot_longer(data = FEM.adl,
                          cols = p_anyadl_100p:p_anyadl_all,
                          names_to = c('Prevalence', 'Condition', 'Age'),
                          names_sep = '_')

p.FEM.adl <- select(p.FEM.adl, -Prevalence, -Condition)

p.FEM.adl$Age <- factor(p.FEM.adl$Age, levels = c('6064', '6569', '7074', '7579', '8084', '8589', '9094', '9599', '100p', 'all'))

ggplot(data = p.FEM.adl, aes(x = year, y = value, colour = Age)) +
  geom_line(aes(fill = Age))

```

# ADL Comparison (Wittenberg)

Data for this comparison came from [this paper](https://people.uea.ac.uk/en/publications/projections-of-demand-and-expenditure-on-adult-social-care-2015-to-2040(d1f44389-4e52-4cb1-9b66-ecc7594d345e).html) - Projections of Demand and Expenditure on Adult Social Care 2015 to 2040. On page 6, base case projections are outlined. Wittenberg says that from 2015 to 2040, the population having at least 1 difficulty in ADL or IADL would rise by 67%, and from 2015 to 2070 would rise by 116%. When considering only ADLs, the increase was 69% from 2015 to 2040, and 124% from 2015 to 2070. Written more clearly:

ADL & IADL
2015 - 2040: 67% increase
2015 - 2070: 116% increase

ADL only
2015 - 2040: 69% increase
2015 - 2070: 124% increase

```{r}

FEM_base <- read_dta('ELSA_Baseline/ELSA_Baseline_summary.dta')

# Get FEM output and extract only p_anyadl_all
FEM.adl <- FEM_base %>%
              select(contains('year'), contains('anyadl')) %>%
              select(-starts_with('i_'), -starts_with('n_'), -starts_with('a_')) %>%
              select(-contains('_m'), -contains('_f')) %>%
              select(contains('year'), contains('_all'))

# Now calculate % increase between 2015 & 2040. Need to take average between 2014 & 2016 values
FEM.2015 <- data.frame(year = 2015, ((FEM.adl[2,2] + FEM.adl[3,2]) / 2))
# extract 2040
FEM.2040 <- filter(FEM.adl, year == 2040)
# Row bind
FEM.2015_2040 <- rbind(FEM.2015, FEM.2040)

# Now calculate percentage change
FEM.adl.perchange <- ((FEM.2015_2040[2,2] - FEM.2015_2040[1,2]) / FEM.2015_2040[2,2]) * 100

# Not good! Showing an 8% reduction in anyadl when we should be seeing a ~70% increase
# Have changed some transition models to see if we can change this significantly
# Now 14% reduction, not good. Need to have a good look at these later.

```

# Stroke Comparison (Wittenberg)

Data from [this paper](https://www.semanticscholar.org/paper/The-future-incidence%2C-prevalence-and-costs-of-in-UK-King-Wittenberg/fdaffc8cd7790556e57c77c0b195c8f7a64c4189) by King et al. (2020). Their model predicts an increase in prevalence of 120% from 2015 to 2035. Also, paper projects that incidence of stroke will increase by 60% each year in the same period. Going to start by comparing the prevalence, but when I come back to this I think it would be interesting to compare incidence also.

```{r}

FEM_base <- read_dta('ELSA_Baseline/ELSA_Baseline_summary.dta')

# Get FEM output and extract only p_anyadl_all
FEM.stroke <- FEM_base %>%
              select(contains('year'), contains('stroke')) %>%
              select(-starts_with('i_'), -starts_with('n_'), -starts_with('a_')) %>%
              select(contains('year'), contains('_all'))
# select(-contains('_m'), -contains('_f')) %>%

FEM.stroke.2015 <- data.frame(year = 2015, ((FEM.stroke[2,2] + FEM.stroke[3,2]) / 2))
FEM.stroke.2040 <- filter(FEM.stroke, year == 2040)
FEM.stroke.2015_2040 <- rbind(FEM.stroke.2015, FEM.stroke.2040)

# Now calculate percentage change
FEM.stroke.perchange <- ((FEM.stroke.2015_2040[2,2] - FEM.stroke.2015_2040[1,2]) / FEM.stroke.2015_2040[2,2]) * 100

# Output showing a ~29% increase in stroke, nowhere near the 120% increase Wittenberg predicts

```

```{r}

FEM_base <- read_dta('ELSA_Baseline/ELSA_Baseline_summary.dta')

# Get FEM output and extract only p_anyadl_all
FEM.dem <- FEM_base %>%
              select(contains('year'), contains('demene')) %>%
              select(-starts_with('i_'), -starts_with('n_'), -starts_with('a_')) %>%
              select(contains('year'), contains('_all'))
# select(-contains('_m'), -contains('_f')) %>%

FEM.dem.2015 <- data.frame(year = 2015, ((FEM.dem[2,2] + FEM.dem[3,2]) / 2))
FEM.dem.2040 <- filter(FEM.dem, year == 2040)
FEM.dem.2015_2040 <- rbind(FEM.dem.2015, FEM.dem.2040)

# Now calculate percentage change
FEM.dem.perchange <- ((FEM.dem.2015_2040[2,2] - FEM.dem.2015_2040[1,2]) / FEM.dem.2015_2040[2,2]) * 100

```



# Bland Altman method of Validation

```{r}
# Contains method for bland-altman validation 
require(MethComp)



```

