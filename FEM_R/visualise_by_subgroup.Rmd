---
title: "R Notebook"
output: html_notebook
---


```{r "setup", include=FALSE}
# Need to set up the environment
workingDir <- "/home/luke/Documents/E_FEM_clean/tmp_output/"
knitr::opts_knit$set(root.dir = workingDir)

require(tidyverse)
require(haven)
require(reshape2)
require(ggplot2)
require(ggpubr)
#require(plyr)
#require(data.table)

rm(workingDir)
```

```{r}
## Read in all the data
# Baselines
base <- read_dta('ELSA_core_base/ELSA_core_base_summary.dta')
cohort <- read_dta('ELSA_core_cohort/ELSA_core_cohort_summary.dta')

# Hearte (cohort and pop)
#heart_c <- read_dta('ELSA_core_remove_hearte_c/ELSA_core_remove_hearte_c_summary.dta')
heart_p <- read_dta('ELSA_core_remove_hearte_p/ELSA_core_remove_hearte_p_summary.dta')

# Smoking (cohort)
smok <- read_dta('ELSA_core_remove_smoken/ELSA_core_remove_smoken_summary.dta')

# BMI
nomorbid <- read_dta('ELSA_core_nomorbid/ELSA_core_nomorbid_summary.dta')
obese2 <- read_dta('ELSA_core_noobese2/ELSA_core_noobese2_summary.dta')
obese1 <- read_dta('ELSA_core_noobese1/ELSA_core_noobese1_summary.dta')

# Drinking
nodrink <- read_dta('ELSA_core_remove_drink_p/ELSA_core_remove_drink_p_summary.dta')
noBadDrink <- read_dta('ELSA_core_remove_problem_drink_p/ELSA_core_remove_problem_drink_p_summary.dta')
```

## Detailed Output Appending

```{r}
# Here we will start to use the detailed output (appended?) to get the rates of chronic diseases by specific subgroups
# Might be an idea to write a general function to get proportion by specific sub group
# Will need arguments: dataset, target variable, subgroups

# save path for ease
base.detail.path <- 'ELSA_core_base/detailed_output/'

# First step is to append all the detailed output files together
base.detail.filelist <- list.files(base.detail.path)
# read first file
base.detail <- read_dta(paste0(base.detail.path, base.detail.filelist[1]))

# read in all the remaining files in a loop and add to base.detail
for (f in base.detail.filelist[-1]) {
  new.df <- read_dta(paste0(base.detail.path, f))
  base.detail <- rbind(base.detail, new.df)
}

rm(new.df, base.detail.path, base.detail.filelist, f)
```

The above chunk has created a MASSIVE stata data file containing the detailed output for every repetition for every year in the simulation. We can use this to do some more detailed analysis by subgroup. 

Lets start with the Heart disease intervention. Will need to create a detailed output file for this intervention scenario as well.

```{r}
heart.detail.path <- 'ELSA_core_remove_hearte_p/detailed_output/'
heart.detail.filelist <- list.files(heart.detail.path)
heart.detail <- read_dta(paste0(heart.detail.path, heart.detail.filelist[1]))

for (f in heart.detail.filelist[-1]) {
  new.df <- read_dta(paste0(heart.detail.path, f))
  heart.detail <- rbind(heart.detail, new.df)
}

rm(new.df, heart.detail.path, heart.detail.filelist, f)
```

## Visualising

Now we have both base and hearte_p detailed output files. What do we do first?

What are our target visualisations?

We want to get the heart disease intervention comparisons by:
- gender
- education level
- age groups
- exstat? Might be interesting

Good start. How do we achieve this? We need the function now to manipulate these files until only the target variables and sub groups remain. I think it is fine to run the function once for each target/sub group pair. Will mean running multiple times on the large datasets but I think this will be fine for now. We can always change this later, and create another function to make reduced datasets.

```{r}
# After a little bit of google fu I think this is actually quite a simple task:
# https://stackoverflow.com/questions/37057784/summary-of-proportions-by-group

base.sumOut <- base.detail %>%
                    count(age, hearte) %>%
                    mutate(prop = prop.table(n))

base.sumOut

heart.sumOut <- heart.detail %>%
                    count(age, hearte) %>%
                    mutate(prop = prop.table(n))
heart.sumOut

# lets plot just to have a look

# give both a source then rbind
base.sumOut$source <- 'Baseline'
heart.sumOut$source <- 'No Heart Disease'

combined <- rbind(base.sumOut, heart.sumOut)

#filter(combined, hearte ==1)

ggplot(data = combined, aes(x = age, y = prop, color = source)) +
  geom_line() +
  facet_wrap('hearte')

rm(base.sumOut, heart.sumOut, combined)
```

```{r}
# Lets try some more groups before we stick it into a function
base.sumOut <- base.detail %>%
                    count(age, male, hearte) %>%
                    mutate(prop = prop.table(n))

base.sumOut

heart.sumOut <- heart.detail %>%
                    count(age, male, hearte) %>%
                    mutate(prop = prop.table(n))
heart.sumOut

# give both a source then rbind
base.sumOut$source <- 'Baseline'
heart.sumOut$source <- 'No Heart Disease'

combined <- rbind(base.sumOut, heart.sumOut)

ggplot(data = filter(combined, hearte == 1), aes(x = age, y = prop, color = source)) +
  geom_line() +
  facet_wrap(vars(male), labeller = "label_both")

rm(base.sumOut, heart.sumOut, combined)
```

Is this what we would expect? I think this shows that women are more likely to have heart disease than men in the FEM. This can't be correct...

Let's look at overall numbers by gender (not broken down by age).

```{r}
base.sumOut <- base.detail %>%
                    count(male, hearte) %>%
                    mutate(prop = prop.table(n))
base.sumOut

heart.sumOut <- heart.detail %>%
                    count(male, hearte) %>%
                    mutate(prop = prop.table(n))
heart.sumOut

# give both a source then rbind
base.sumOut$source <- 'Baseline'
heart.sumOut$source <- 'No Heart Disease'

combined <- rbind(base.sumOut, heart.sumOut)

combined$male <- factor(combined$male)

ggplot(data = filter(combined, hearte == 1), aes(x = male, y = prop, color = source)) +
  geom_bar(aes(fill = source), stat = "identity", position = "dodge")
```

Now lets try and do it so that the proportions are relative.

```{r}
base.sumOut <- base.detail %>%
                    group_by(age, hearte) %>%
                    summarise(n = n()) %>%
                    mutate(freq = n / sum(n))
heart.sumOut <- heart.detail %>%
                    group_by(age, hearte) %>%
                    summarise(n = n()) %>%
                    mutate(freq = n / sum(n))
head(base.sumOut)
head(heart.sumOut)

# lets plot just to have a look

# give both a source then rbind
base.sumOut$source <- 'Baseline'
heart.sumOut$source <- 'No Heart Disease'

combined <- rbind(base.sumOut, heart.sumOut)

#filter(combined, hearte ==1)

ggplot(data = combined, aes(x = age, y = freq, color = source)) +
  geom_line() +
  facet_wrap('hearte')

rm(base.sumOut, heart.sumOut, combined)
```
This is much better! The frequency's are relative in this attempt, which makes it much easier to understand and compare. Now to recreate the next 2 graphs with relative frequencies instead of proportions.


```{r}
# Lets try some more groups before we stick it into a function
base.sumOut <- base.detail %>%
                    group_by(age, male, hearte) %>%
                    summarise(n = n()) %>%
                    mutate(freq = n / sum(n))
heart.sumOut <- heart.detail %>%
                    group_by(age, male, hearte) %>%
                    summarise(n = n()) %>%
                    mutate(freq = n / sum(n))
head(base.sumOut)
head(heart.sumOut)

# give both a source then rbind
base.sumOut$source <- 'Baseline'
heart.sumOut$source <- 'No Heart Disease'

combined <- rbind(base.sumOut, heart.sumOut)

ggplot(data = filter(combined, hearte == 1), aes(x = age, y = freq, color = source)) +
  geom_line() +
  facet_wrap(vars(male), labeller = "label_both")

rm(base.sumOut, heart.sumOut, combined)
```

```{r}
base.sumOut <- base.detail %>%
                    group_by(male, hearte) %>%
                    summarise(n = n()) %>%
                    mutate(freq = n / sum(n))
heart.sumOut <- heart.detail %>%
                    group_by(male, hearte) %>%
                    summarise(n = n()) %>%
                    mutate(freq = n / sum(n))
head(base.sumOut)
head(heart.sumOut)

# give both a source then rbind
base.sumOut$source <- 'Baseline'
heart.sumOut$source <- 'No Heart Disease'

combined <- rbind(base.sumOut, heart.sumOut)

combined$male <- factor(combined$male)

ggplot(data = filter(combined, hearte == 1), aes(x = male, y = freq, color = source)) +
  geom_bar(aes(fill = source), stat = "identity", position = "dodge")
```



```{r}
# FUnction time

relFreq.subgroup <- function(base, int, target, subgroup) {
  
  base.sumOut <- base %>%
                    group_by(!!subgroup, !!target) %>%
                    summarise(n = n()) %>%
                    mutate(freq = n / sum(n))
  heart.sumOut <- int %>%
                    group_by(!!subgroup, !!target) %>%
                    summarise(n = n()) %>%
                    mutate(freq = n / sum(n))
  
  # give both a source then rbind
  base.sumOut$source <- 'Baseline'
  heart.sumOut$source <- 'No Heart Disease'
  
  combined <- rbind(base.sumOut, heart.sumOut)
  
  ggplot(data = combined, aes(x = !!subgroup, y = freq, color = source)) +
  geom_line() +
  facet_wrap(target, labeller = "label_both")
}

relFreq.subgroup(base.detail, heart.detail, quo(hearte), quo(age))
```


```{r}
relFreq.subgroup.factor <- function(base, int, target, subgroup) {
  base.sumOut <- base %>%
                    group_by(!!subgroup, !!target) %>%
                    summarise(n = n()) %>%
                    mutate(freq = n / sum(n))
  heart.sumOut <- int %>%
                    group_by(!!subgroup, !!target) %>%
                    summarise(n = n()) %>%
                    mutate(freq = n / sum(n))
  
  # give both a source then rbind
  base.sumOut$source <- 'Baseline'
  heart.sumOut$source <- 'No Heart Disease'
  
  combined <- rbind(base.sumOut, heart.sumOut)
  
  #combined$target <- factor(combined$target)
  
  ggplot(data = filter(combined, !!target == 1), aes(x = !!subgroup, y = freq, color = source)) +
    geom_bar(aes(fill = source), stat = "identity", position = "dodge")
}

relFreq.subgroup.factor(base.detail, heart.detail, quo(hearte), quo(male))
```


