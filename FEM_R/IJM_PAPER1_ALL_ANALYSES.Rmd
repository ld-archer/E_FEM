---
title: "R Notebook"
output: html_notebook
---

# Setup

## Libraries
```{r "setup", include=FALSE}
require(tidyverse)
require(haven)
require(ggplot2)
require(Hmisc)
require(reshape2)

theme_set(theme_bw())

workingDir <- "/home/luke/Documents/E_FEM_clean/E_FEM/"
knitr::opts_knit$set(root.dir = workingDir)

rm(workingDir)
```

## Starting Populations
```{r}
stock <- read_dta('input_data/ELSA_stock.dta')
repl <- read_dta('input_data/ELSA_repl.dta')
trans <- read_dta('input_data/ELSA_transition.dta')
```

# Methods

## Summary Stats for Starting Populations

### Function Declaration
```{r}
require(survey)
weighted.survey.means <- function(init.pop, transition=FALSE) {
  
  if(!transition) {
    design <- svydesign(id = ~idauniq,
                      weights = ~weight,
                      data = init.pop)
  } else if(transition) {
    # Error from missing cwtresp var - drop all that are missing to solve
    init.pop <- init.pop[complete.cases(init.pop$cwtresp),]
    design <- svydesign(id = ~idauniq,
                      weights = ~cwtresp,
                      data = init.pop)
  }
  print(svymean(~age, design, na.rm=TRUE))
  print(svyvar(~age, design, na.rm=TRUE))
  print(svymean(~male, design, na.rm=TRUE))
  print(svymean(~bmi, design, na.rm=TRUE))
  print(svyvar(~bmi, design, na.rm=TRUE))
  print(svymean(~smoken, design, na.rm=TRUE))
  print(svymean(~smokev, design, na.rm=TRUE))
  print(svymean(~hsless, design, na.rm=TRUE))
  print(svymean(~college, design, na.rm=TRUE))
  print('---------------------')
  print(svymean(~cancre, design, na.rm=TRUE))
  print(svymean(~diabe, design, na.rm=TRUE))
  print(svymean(~hearte, design, na.rm=TRUE))
  print(svymean(~stroke, design, na.rm=TRUE))
  print(svymean(~lunge, design, na.rm=TRUE))
  print(svymean(~hibpe, design, na.rm=TRUE))
  print(svymean(~alzhe, design, na.rm=TRUE))
  print(svymean(~demene, design, na.rm=TRUE))
  print(svymean(~hchole, design, na.rm=TRUE))
}
```

### Stock
```{r}
weighted.survey.means(stock)
```

### Replenishing
```{r}
weighted.survey.means(repl)
```

### Transition
```{r}
weighted.survey.means(trans, transition=TRUE)
```

#### Incidence
```{r}
getIncidenceRate <- function(t, var) {
  
  l2var <- paste0('l2', var)
  
  select.vars <- c(var, l2var)
  
  t <- select(t, year, all_of(select.vars))
  t$incidence.counts <- (t[,var] == 1) & (t[,l2var] == 0)
  
  t <- t %>%
          summarise(n = n(), newIn = sum(incidence.counts, na.rm=TRUE)) %>%
          mutate(incidence.rate = (newIn / n) * 100)
  
  t$var <- var
  
  return(t)
}

getIncidenceRate(trans, 'cancre')
getIncidenceRate(trans, 'diabe')
getIncidenceRate(trans, 'hearte')
getIncidenceRate(trans, 'stroke')
getIncidenceRate(trans, 'lunge')
getIncidenceRate(trans, 'hibpe')
getIncidenceRate(trans, 'alzhe')
getIncidenceRate(trans, 'demene')
getIncidenceRate(trans, 'hchole')
```

# Validation

## Handovers

Handover plots are generated from a Stata script that can be called via a Make rule (`make handovers`). The core_complete set of scenarios must be run prior to this with the `55p_f_l` & `55p_m_l` subpopulations.

## ROC plots

ROC plots are also generated via a Stata script. The entire workflow for generating ROC plots (including running two scenarios for 500 repetitions) is handled by another Make rule (`make roc`).

## AgeUK validation

```{r echo = FALSE}
# #AgeUK
# male_au <- read.csv('../Validation/AgeUK-chronDisease-MALE.csv')
# female_au <- read.csv('../Validation/AgeUK-chronDisease-FEMALE.csv')
# 
# # FEM 2014 detailed output
# #FEM_2014 <- read_dta('ELSA_Baseline/detailed_output/y2014_rep1.dta')
# ## extract males and females
# #mFEM_2014 <- FEM_2014 %>% filter(male == 1)
# #fFEM_2014 <- FEM_2014 %>% filter(male == 0)
# 
# # FEM 2014 summary
# #FEM <- read_dta('ELSA_Baseline/ELSA_Baseline_summary.dta')
# FEM <- read_dta('output/COMPLETE/ELSA_AgeUK_core_valid/ELSA_AgeUK_core_valid_summary.dta')
# 
# # Keep only year 2014 from FEM summary
# FEM <- filter(FEM, year == 2014)
# 
# # Specify the age groups to extract from FEM
# ages <- c('6064', '6569', '7074', '7579', '8084', '8589', '9094', '9599', '100p')
# # Add m and f for male and female variables
# m_ages <- paste0('m_', ages)
# f_ages <- paste0('f_', ages)
# 
# # Collect the age suffixes into a vector
# keep_vars <- c(m_ages, f_ages)
# # Now set up the chronic diseases in a list so we can create a bigger list with all of them produced
# diseases <- c('hibpe', 'stroke', 'diabe', 'demene', 'asthmae')
# 
# # Don't like using loops but this one was just too simple to bother with figuring out the apply version
# final <- c()
# ticker <- 1
# # Generating the column (variable) names we want to keep in a loop
# for(item in diseases) {
#   for(anotherItem in keep_vars) {
#     final[ticker] <- paste0('p_', item, '_', anotherItem)
#     ticker <- ticker + 1
#   }
# }
# 
# # Keep the right vars using varnames generated in loop
# FEM <- FEM %>%
#           select(c('year', all_of(final)))
# 
# # Rename some vars to remove 'p_' before merging
# FEM <- FEM %>%
#           rename_at(vars(starts_with('p_')),
#                     funs(str_replace(., 'p_', ''))) %>%
#           select(!year)
# 
# pivoted.FEM <- pivot_longer(data = FEM,
#                             cols = hibpe_m_6064:asthmae_f_100p, 
#                             names_to = c('Condition', 'Gender', 'Age_Group'), 
#                             names_sep = '_')
# 
# # Convert value from fraction to percentage
# pivoted.FEM$value <- pivoted.FEM$value * 100
# 
# # Rename cols to enable reshaping
# male_au <- male_au %>%
#                 dplyr::rename(m_6064 = X60.64, m_6569 = X65.69, m_7074 = X70.74, 
#                        m_7579 = X75.79, m_8084 = X80.84, m_8589 = X85.89, 
#                        m_9094 = X90.94, m_9599 = X95.99, m_100p = Over.100) %>%
#                 select(!Total)
# 
# female_au <- female_au %>%
#                 dplyr::rename(f_6064 = X60.64, f_6569 = X65.69, f_7074 = X70.74, 
#                        f_7579 = X75.79, f_8084 = X80.84, f_8589 = X85.89, 
#                        f_9094 = X90.94, f_9599 = X95.99, f_100p = Over.100) %>%
#                 select(!Total)
# 
# # Now need to reshape these datasets to long format
# pivoted.male <- pivot_longer(data = male_au,
#                              cols = m_6064:m_100p,
#                              names_to = c('Gender', 'Age_Group'),
#                              names_sep = '_')
# 
# pivoted.female <- pivot_longer(data = female_au,
#                              cols = f_6064:f_100p,
#                              names_to = c('Gender', 'Age_Group'),
#                              names_sep = '_')
# 
# # Now row bind these frames together, combining male and female data
# ageUK <-rbind(pivoted.male, pivoted.female)
# 
# # Now need to deal with the fact that ageUK data splits heart issues into 3 different conditions
# # extract all heart related conditions for combining
# #ageUK_heart <- filter(ageUK, Condition == c('Coronary Heart Disease', 'Heart Failure', 'Atrial Fibrillation'))
# # Aggregate the values by gender and age group
# #ageUK_heart <- aggregate(ageUK_heart$value, by = list(ageUK_heart$Gender, ageUK_heart$Age_Group), FUN = sum)
# # Rename columns and add condition column back
# #colnames(ageUK_heart) <- c('Gender', 'Age_Group', 'value')
# #ageUK_heart$Condition <- 'Heart Problems'
# 
# # Now drop the heart problems from original ageUK and replace with aggregate
# ageUK <- filter(ageUK, Condition != 'Coronary Heart Disease', Condition != 'Heart Failure', Condition != 'Atrial Fibrillation')
# #ageUK <- rbind(ageUK, ageUK_heart)
# 
# # Rename a few just for completeness
# #ageUK$Condition <- gsub("Cancer, recent", "Cancer", ageUK$Condition)
# #ageUK$Condition <- gsub("COPD", "Lung Disease (COPD)", ageUK$Condition)
# 
# # Finally, add column to specify that this is ageUK data
# ageUK$source <- "ageUK"
# 
# # REMOVE CONDITIONS FROM ageUK THAT ARE NOT IN FEM (may change in future)
# #ageUK <- filter(ageUK, Condition != c('Asthma', 'Depression', 'Severe Mental Health Condition'))
# ageUK <- filter(ageUK, Condition != 'Depression', Condition != 'Severe Mental Health Conditions')
# ageUK <- filter(ageUK, Condition != 'Cancer, recent', Condition != 'COPD')
# 
# # Make copy
# newFEM <- pivoted.FEM
# 
# # Rename all the conditions to fit ageUK
# # NOTE: Lung disease is not a perfect match, as ageUK only contains info on COPD
# #       Therefore only validation from this will be that FEM is higher than ageUK
# #newFEM$Condition <- gsub("hearte", "Heart Problems", newFEM$Condition)
# newFEM$Condition <- gsub("hibpe", "Hypertension", newFEM$Condition)
# newFEM$Condition <- gsub("stroke", "Stroke", newFEM$Condition)
# newFEM$Condition <- gsub("diabe", "Diabetes", newFEM$Condition)
# #newFEM$Condition <- gsub("lunge", "Lung Disease (COPD)", newFEM$Condition)
# #newFEM$Condition <- gsub("cancre", "Cancer", newFEM$Condition)
# newFEM$Condition <- gsub("demene", "Dementia", newFEM$Condition)
# newFEM$Condition <- gsub("asthmae", "Asthma", newFEM$Condition)
# 
# 
# #force Make to run this again
# 
# # Add column to specify this is FEM data
# newFEM$source <- "FEM"
# 
# # Now row bind the datasets
# combined <- rbind(newFEM, ageUK)
# # Specify factor levels for age group
# combined$Age_Group <- factor(combined$Age_Group, levels = c('6064', '6569', '7074', '7579', '8084', '8589', '9094', '9599', '100p'))
# # Sort
# combined <- arrange(combined, source, Condition, Gender, Age_Group)
# 
# # Function to filter the combined dataset and visualise
# visAgeUKValid <- function(data, cd, gender, path = '/home/luke/Documents/E_FEM_clean/Deliverables/E-FEM_Paper/figures/validation/ageUK/') {
#   
#   if(gender == 'm') {
#     full_gender <- 'Male'
#   }
#   else if(gender == 'f') {
#     full_gender <- 'Female'
#   }
#   
#   # filter by gender and condition
#   data <- data %>%
#             filter(Gender == gender) %>%
#             filter(Condition == cd)
#   
#   # now plot!
#   p <- ggplot(data = data, aes(x = Age_Group, y = value)) +
#           geom_bar(aes(fill = source), stat = "identity", position = "dodge") +
#           labs(title = paste(cd, full_gender, sep = ' '), x = 'Age Group', y = 'Proportion')
#   
#   # Save plot into in E-FEM_Paper/figures/
#   ggsave(filename = paste0(cd, '_', gender, '.png'),
#          plot = p,
#          path = path,
#          width = 6,
#          height = 4)
#   
#   return(p)
# }

```

```{r echo=FALSE}
# Collect all conditions (and both genders) into a list, and apply the function above to that list
# cd_list <- unique(combined$Condition)
# gender_list <- unique(combined$Gender)
# 
# for(cd in cd_list) {
#   for(gen in gender_list) {
#     plot <- visAgeUKValid(combined, cd, gen)
#     print(plot)
#   }
# }
```


## Smoking
```{r}
FEM_base <- read_dta('output/COMPLETE/ELSA_core_base/ELSA_core_base_summary.dta')

# Smoking prevalence stats
smok.5059 <- 15.2
smok.60p <- 10.2

# FEM summary, filter for 2018 and 60p
#FEM.smok <- FEM_sum
FEM.smok <- FEM_base
FEM.smok <- FEM.smok %>%
                filter(year == 2018) %>%
                select(contains('smoken')) %>%
                select(contains('60p'), contains('5059')) %>%
                select(contains('p_'))

FEM.smok <- FEM.smok * 100

smok.combined <- data.frame(FEM = FEM.smok[1,1], ASH = 10.2)
smok.combined <- data.frame(source = c('FEM', 'FEM', 'ASH', 'ASH'), age = c('50 - 59', '60+', '50 - 59', '60+'), value = c(FEM.smok[1,2], FEM.smok[1,1], 15.2, 10.2))

smok.plot <-ggplot(data = smok.combined, aes(x = age, y = value)) +
                geom_bar(aes(fill = source), stat = "identity", position = "dodge") +
                labs(x = ' ', y = 'Prevalence (%)')

ggsave(filename = 'smoking_prev_2018.png',
       plot = smok.plot,
       path = '/home/luke/Documents/E_FEM_clean/Deliverables/E-FEM_Paper/figures/validation/smok_prev/',
       width = 7,
       height = 5)

smok.plot

```

# Results

## Heart Disease Intervention
```{r echo=FALSE}
# compareDeathAge <- function(base, int, int_name, save=FALSE, path='/home/luke/Documents/E_FEM_clean/Deliverables/E-FEM_Paper/figures/results/') {
#   
#   aDeath <- data.frame(base$year, base$d_age_all, int$d_age_all)
#   
#   aDeath <- aDeath %>%
#                 dplyr::rename('Year' = base.year, 'Baseline' = base.d_age_all, !!quo_name(int_name) := int.d_age_all) %>%
#                 reshape2::melt(id.var = 'Year', value.name = 'Age')
#   
#   p1 <- ggplot(data = aDeath, aes(x = Year, y = Age, color = variable)) +
#         geom_smooth(lwd = 0.5, se=FALSE) +
#         labs(x = 'Year', y = 'Age at Death') +
#   
#   if(save) {
#     ggsave(filename = 'hearte_dAge_all.png',
#          plot = p1,
#          path = path)
#   }
#   
#   return(p1)
# }
```

### Life-Expectancy
```{r echo=FALSE}
# b <- read_dta('output/SCENARIO/ELSA_core_base/ELSA_core_base_summary.dta')
# h_p <- read_dta('output/SCENARIO/ELSA_core_remove_hearte_p/ELSA_core_remove_hearte_p_summary.dta')
# 
# compareDeathAge(b, h_p, 'No Heart Disease', save=FALSE)
```

#### With Confidence Intervals
```{r}
b_rep <- read_dta('output/SCENARIO/ELSA_core_base/ELSA_core_base_by_rep.dta')
h_rep <- read_dta('output/SCENARIO/ELSA_core_remove_hearte_p/ELSA_core_remove_hearte_p_by_rep.dta')

compareDeathAgeConfints <- function(b, i, int_name=FALSE, save=FALSE, path='/home/luke/Documents/E_FEM_clean/Deliverables/E-FEM_Paper/figures/results/') {
  
  aDet <- data.frame(b$year, b$rep, b$d_age_all, i$d_age_all)
  
  aDet2 <- aDet %>% 
            dplyr::rename('Year' = b.year, 'Rep' = b.rep, 'Baseline' = b.d_age_all, !!quo_name(int_name) := i.d_age_all) %>%
            pivot_longer(
                cols = Baseline:'No Heart Disease',
                names_to = 'Source',
                values_to = 'Life_Exp'
            )
  
  p <- ggplot(data = aDet2, aes(x = Year, y = Life_Exp, color = Source)) +
          geom_smooth(lwd = 0.5) +
          labs(y = 'Life Expectancy')
  
  if(save) {
    ggsave(filename = 'hearte_dAge_all.png',
         plot = p,
         path = path)
  }
  
  p
}


compareDeathAgeConfints(b_rep, h_rep, int_name = 'No Heart Disease', save=TRUE)

```


### Split by Activity Level
```{r}
b <- b_rep
h <- h_rep

d.exstat1 <- data.frame(b$year, b$rep, b$d_age_exstat1, h$d_age_exstat1)
d.exstat1 <- d.exstat1 %>%
                dplyr::rename('Year' = b.year, 'Rep' = b.rep, 'Baseline' = b.d_age_exstat1, 'Intervention' = h.d_age_exstat1)
d.exstat1.pivot <- pivot_longer(d.exstat1,
                              cols = Baseline:Intervention,
                              names_to = 'Source',
                              values_to = 'Life_Expectancy')
p1 <- ggplot(data = d.exstat1.pivot, aes(x = Year, y = Life_Expectancy, color = Source)) +
      geom_smooth(lwd = 0.5) +
      labs(title = 'Low', x = 'Year', y = 'Life Expectancy')
p1

d.exstat2 <- data.frame(b$year, b$rep, b$d_age_exstat2, h$d_age_exstat2)
d.exstat2 <- d.exstat2 %>%
                dplyr::rename('Year' = b.year, 'Rep' = b.rep, 'Baseline' = b.d_age_exstat2, 'Intervention' = h.d_age_exstat2)
d.exstat2.pivot <- pivot_longer(d.exstat2,
                              cols = Baseline:Intervention,
                              names_to = 'Source',
                              values_to = 'Life_Expectancy')
p2 <- ggplot(data = d.exstat2.pivot, aes(x = Year, y = Life_Expectancy, color = Source)) +
      geom_smooth(lwd = 0.5) +
      labs(title = 'Moderate', x = 'Year', y = 'Life Expectancy') +
      scale_fill_grey()
p2

d.exstat3 <- data.frame(b$year, b$rep, b$d_age_exstat3, h$d_age_exstat3)
d.exstat3 <- d.exstat3 %>%
                dplyr::rename('Year' = b.year, 'Rep' = b.rep, 'Baseline' = b.d_age_exstat3, 'Intervention' = h.d_age_exstat3)
d.exstat3.pivot <- pivot_longer(d.exstat3,
                              cols = Baseline:Intervention,
                              names_to = 'Source',
                              values_to = 'Life_Expectancy')
p3 <- ggplot(data = d.exstat3.pivot, aes(x = Year, y = Life_Expectancy, color = Source)) +
      geom_smooth(lwd = 0.5) +
      labs(title = 'High', x = 'Year', y = 'Life Expectancy')
p3

path <- '/home/luke/Documents/E_FEM_clean/Deliverables/E-FEM_Paper/figures/results/'

ggsave(filename = 'hearte_dAge_exstat1.png',
         plot = p1,
         path = path)

ggsave(filename = 'hearte_dAge_exstat2.png',
         plot = p2,
         path = path)

ggsave(filename = 'hearte_dAge_exstat3.png',
         plot = p3,
         path = path)

```

### SplitbyEduc
```{r}
b <- b_rep
h <- h_rep

d.educ1 <- data.frame(b$year, b$rep, b$d_age_educ1, h$d_age_educ1)
d.educ1 <- d.educ1 %>%
                dplyr::rename('Year' = b.year, 'Rep' = b.rep, 'Baseline' = b.d_age_educ1, 'Intervention' = h.d_age_educ1)
d.educ1.pivot <- pivot_longer(d.educ1,
                              cols = Baseline:Intervention,
                              names_to = 'Source',
                              values_to = 'Life_Expectancy')
p1 <- ggplot(data = d.educ1.pivot, aes(x = Year, y = Life_Expectancy, color = Source)) +
      geom_smooth(lwd = 0.5) +
      labs(title = 'Low', x = 'Year', y = 'Life Expectancy')
p1

d.educ2 <- data.frame(b$year, b$rep, b$d_age_educ2, h$d_age_educ2)
d.educ2 <- d.educ2 %>%
                dplyr::rename('Year' = b.year, 'Rep' = b.rep, 'Baseline' = b.d_age_educ2, 'Intervention' = h.d_age_educ2)
d.educ2.pivot <- pivot_longer(d.educ2,
                              cols = Baseline:Intervention,
                              names_to = 'Source',
                              values_to = 'Life_Expectancy')
p2 <- ggplot(data = d.educ2.pivot, aes(x = Year, y = Life_Expectancy, color = Source)) +
      geom_smooth(lwd = 0.5) +
      labs(title = 'Moderate', x = 'Year', y = 'Life Expectancy') +
      scale_fill_grey()
p2

d.educ3 <- data.frame(b$year, b$rep, b$d_age_educ3, h$d_age_educ3)
d.educ3 <- d.educ3 %>%
                dplyr::rename('Year' = b.year, 'Rep' = b.rep, 'Baseline' = b.d_age_educ3, 'Intervention' = h.d_age_educ3)
d.educ3.pivot <- pivot_longer(d.educ3,
                              cols = Baseline:Intervention,
                              names_to = 'Source',
                              values_to = 'Life_Expectancy')
p3 <- ggplot(data = d.educ3.pivot, aes(x = Year, y = Life_Expectancy, color = Source)) +
      geom_smooth(lwd = 0.5) +
      labs(title = 'High', x = 'Year', y = 'Life Expectancy')
p3

path <- '/home/luke/Documents/E_FEM_clean/Deliverables/E-FEM_Paper/figures/results/test/'

ggsave(filename = 'hearte_dAge_educ1.png',
         plot = p1,
         path = path)

ggsave(filename = 'hearte_dAge_educ2.png',
         plot = p2,
         path = path)

ggsave(filename = 'hearte_dAge_educ3.png',
         plot = p3,
         path = path)

```


## Smoking Intervention
```{r echo=FALSE}
# compareSurvivalCurve <- function(cohort, intervention, int_name, save=FALSE,
#                                  path='/home/luke/Documents/E_FEM_clean/Deliverables/E-FEM_Paper/figures/results/') {
#   
#   # Calculate age and survival curves
#   cohort$Age <- (cohort$year - 2012) + 50
#   intervention$Age <- (intervention$year - 2012) + 50
#   cohort$Survival <- cohort$m_endpop_all / cohort$m_endpop_all[1]
#   intervention$Survival <- intervention$m_endpop_all / intervention$m_endpop_all[1]
#   
#   survivals <- data.frame(cohort$Age, cohort$Survival, intervention$Survival)
#   
#   # Had a small problem when trying to rename using the variable name given as function argument
#   # Found solution here: https://stackoverflow.com/questions/49650394/how-to-rename-a-variable-using-a-dynamic-name-and-dplyr
#   survivals <- survivals %>%
#                  dplyr::rename('Age' = cohort.Age, 'Baseline' = cohort.Survival, !!quo_name(int_name) := intervention.Survival) %>%
#                  melt(id.var = 'Age', value.name = 'Survival')
#   
#   p1 <-ggplot(data = survivals, aes(x=Age, y=Survival, color = variable)) +
#         geom_line() +
#         labs(x = 'Age', y = 'Survival')
#   
#   if(save) {
#     ggsave(filename = paste0(int_name, '_survival_curve.png'),
#          plot = p1,
#          path = path)
#   }
#   
#   return(p1)
# }
```


### Survival Curve
```{r echo=FALSE}
# c <- read_dta('output/SCENARIO/ELSA_core_cohort/ELSA_core_cohort_summary.dta')
# s <- read_dta('output/SCENARIO/ELSA_core_remove_smoken/ELSA_core_remove_smoken_summary.dta')
# 
# compareSurvivalCurve(c, s, 'No Smoking', save=FALSE)
```

#### Confidence Intervals
```{r}
compareSurvivalCurveConfints <- function(cohort, intervention, int_name, save=FALSE,
                                 path='/home/luke/Documents/E_FEM_clean/Deliverables/E-FEM_Paper/figures/results/') {
  
  # Calculate age and survival curves
  cohort$Age <- (cohort$year - 2012) + 50
  intervention$Age <- (intervention$year - 2012) + 50
  cohort$Survival <- cohort$m_endpop_all / cohort$m_endpop_all[1]
  intervention$Survival <- intervention$m_endpop_all / intervention$m_endpop_all[1]
  
  survivals <- data.frame(cohort$Age, cohort$rep, cohort$Survival, intervention$Survival)
  
  # Had a small problem when trying to rename using the variable name given as function argument
  # Found solution here: https://stackoverflow.com/questions/49650394/how-to-rename-a-variable-using-a-dynamic-name-and-dplyr
  survivals <- survivals %>%
                 dplyr::rename('Age' = cohort.Age, 'Rep' = cohort.rep, 'Baseline' = cohort.Survival, !!quo_name(int_name) := intervention.Survival) %>%
                 pivot_longer(
                   cols = Baseline:'No Smoking',
                   names_to = 'Source',
                   values_to = 'Life_Exp'
                 )
  
  p <-ggplot(data = survivals, aes(x=Age, y=Life_Exp, color = Source)) +
        geom_smooth(lwd = 0.5) +
        labs(x = 'Age', y = 'Survival')
  
  if(save) {
    ggsave(filename = paste0(int_name, '_survival_curve.png'),
         plot = p,
         path = path)
  }
  
  return(p)
}

c_rep <- read_dta('output/COMPLETE/ELSA_core_cohort/ELSA_core_cohort_by_rep.dta')
s_rep <- read_dta('output/SCENARIO/ELSA_core_remove_smoken/ELSA_core_remove_smoken_by_rep.dta')

compareSurvivalCurveConfints(c_rep, s_rep, 'No Smoking', save=TRUE)
```


### Lung Disease Prevalence All
```{r}
c <- read_dta('output/SCENARIO/ELSA_core_cohort/ELSA_core_cohort_summary.dta')
s <- read_dta('output/SCENARIO/ELSA_core_remove_smoken/ELSA_core_remove_smoken_summary.dta')

# Calculate age and survival curves
c$Age <- (c$year - 2012) + 50
s$Age <- (s$year - 2012) + 50
c$Survival <- c$m_endpop_all / c$m_endpop_all[1]
s$Survival <- s$m_endpop_all / s$m_endpop_all[1]

d.all <- data.frame(c$Age, c$p_lunge_all, s$p_lunge_all)
d.all <- d.all %>%
                dplyr::rename('Age' = c.Age, 'Baseline' = c.p_lunge_all, 'Intervention' = s.p_lunge_all)
d.all.pivot <- pivot_longer(d.all,
                              cols = Baseline:Intervention,
                              names_to = 'Source',
                              values_to = 'Prevalence')
p1 <- ggplot(data = d.all.pivot, aes(x = Age, y = Prevalence, color = Source)) +
      geom_smooth(lwd = 0.5, se=FALSE) +
      labs(x = 'Age', y = 'Prevalence')
p1

path <- '/home/luke/Documents/E_FEM_clean/Deliverables/E-FEM_Paper/figures/results'

#ggsave(filename = 'smok_lunge_all.png',
#         plot = p1,
#         path = path)
```

```{r}
c <- c_rep
s <- s_rep

# Calculate age and survival curves
c$Age <- (c$year - 2012) + 50
s$Age <- (s$year - 2012) + 50
c$Survival <- c$m_endpop_all / c$m_endpop_all[1]
s$Survival <- s$m_endpop_all / s$m_endpop_all[1]

d.all <- data.frame(c$Age, c$rep, c$p_lunge_all, s$p_lunge_all)
d.all <- d.all %>%
                dplyr::rename('Age' = c.Age, 'Rep' = c.rep, 'Baseline' = c.p_lunge_all, 'Intervention' = s.p_lunge_all)
d.all.pivot <- pivot_longer(d.all,
                              cols = Baseline:Intervention,
                              names_to = 'Source',
                              values_to = 'Prevalence')
p1 <- ggplot(data = d.all.pivot, aes(x = Age, y = Prevalence, color = Source)) +
      geom_smooth(lwd = 0.5) +
      labs(x = 'Age', y = 'Prevalence')
p1

path <- '/home/luke/Documents/E_FEM_clean/Deliverables/E-FEM_Paper/figures/results'

ggsave(filename = 'smok_lunge_all.png',
         plot = p1,
         path = path)
```

### Life Years & DFLYS
```{r}
aData <- read_dta('/home/luke/Documents/E_FEM_clean/E_FEM/input_data/detailed_output/tot/base_treated_merged_smoken_tot_test.dta')

all2 <- aData %>%
          summarise(base.ly = mean(total_lifeyears_basecase), int.ly = mean(total_lifeyears),
                    base.dfly = mean(total_dflys_basecase), int.dfly = mean(total_dflys))

all2
```

#### Split by Education
```{r}
educ2 <- aData %>%
          group_by(educ) %>%
          summarise(base.ly = mean(total_lifeyears_basecase), int.ly = mean(total_lifeyears),
                    base.dfly = mean(total_dflys_basecase), int.dfly = mean(total_dflys))

educ2
```

