---
title: "Generate Mortality Adjustment for FEM"
output: html_notebook
author: Luke Archer
email: l.archer@leeds.ac.uk
---

This notebook will go through the steps taken to generate the mortality adjustment table for the FEM.

The mortality adjustment is a table that specifies how the mortality rate should be adjusted over time in the FEM. As a rule, the mortality rate is decreasing over time. The original US version divided the mortality adjustment into a rate for those aged below 65, and those aged above. As the data we are using contains information by gender and single year of age, we will instead attempt to make a version of this with a separate rate by gender and single year of age.

```{r setup, include = FALSE}

# Need to set up the environment
workingDir <- "/home/luke/Documents/E_FEM_clean/E_FEM/"
knitr::opts_knit$set(root.dir = workingDir)

require(tidyverse)
require(readODS)

```


First lets read in the .xls document containing the life tables. The life tables are divided into period and cohort life tables, which are further subdivided by gender, resulting in 4 separate life tables: a cohort and period life table for men, and the same for women.

```{r}

#ppp <- read_excel('../Mortality_Projections/engppp18ex.ods')
m_period <- read_ods('../Mortality_Projections/engppp18ex.ods',
                     sheet = 3,
                     skip = 9,
                     row_names = TRUE)
f_period <- read_ods('../Mortality_Projections/engppp18ex.ods',
                     sheet = 4,
                     skip = 9,
                     row_names = TRUE)
m_cohort <- read_ods('../Mortality_Projections/engppp18ex.ods',
                     sheet = 5,
                     skip = 9,
                     row_names = FALSE)
f_cohort <- read_ods('../Mortality_Projections/engppp18ex.ods',
                     sheet = 6,
                     skip = 9,
                     row_names = FALSE)

m_period <- m_period[-1,]
f_period <- f_period[-1,]
m_cohort <- m_cohort[-1,]
f_cohort <- f_cohort[-1,]

```

Before using this data to calculate mortality adjustment, we will produce one version using the assumptions laid out in [this](http://www.ssisi.ie/SSISI172Naqvi&WhelanRevised20190614.pdf) paper assessing different methodologies of estimating future life expectancies (focussing on Table VII on page 15). The paper has a detailed comparison between UK (ONS) and Irish (CSO) outputs, providing information on the assumptions made to produce the UK outputs. Here, we will use these assumptions to generate a mortality adjustment table, and we can use this to compare with a more granular version we will create soon using the life tables we loaded in in the previous chunk. 

SIDELINE THE ABOVE, not doing this first might have a go later.

```{r}

#PASS

```

Forget the previous paragraph and chunk for a bit, instead we're going to try to use the cohort life tables to work out an age and gender specific life expectancy for each year.

```{r}

# First drop all ages below 50 for both male and female dfs
#male <- tibble::rownames_to_column(m_cohort) # create copy of df so we can run this chunk independantly if we make mistakes
male <- m_cohort %>% rename(Age = 'Attained age (years)')
female <- f_cohort %>% rename(Age = 'Attained age (years)')

# Filter out ages below 50
male <- male %>% filter(Age >= 50)
female <- female %>% filter(Age >= 50)

# Replace rownames with values from Age row
rownames(male) <- male$Age
rownames(female) <- female$Age
male <- subset(male, select = -Age)
female <- subset(female, select = -Age)


# Testing where the value for 50 yr old in 2012 is
#foo <- male[1,33]
#print(foo)
# Now normalise to the value for a 50 year old in 2012
male_norm <- male / male[1,32]
female_norm <- female / female[1,32]

male_norm

# Divide all by 1 to flip the values, so values below 1 mean reduction in mortality, and vice versa
m_inv <- 1 / male_norm
f_inv <- 1 / female_norm

m_inv


```


HAD A BETTER IDEA! Not going to remove the above chunk but I think I have figured out a mistake, going to try again. I think instead of scaling to single value for a 50 year old in 2012, I think we need to scale to the values for all ages in 2012. Then, we would have a value of 1 for every age in 2012, and the values would change over time, at a different rate for each age. 


```{r}
# Rename age column and filter out ages below 50
male <- m_cohort %>% 
            rename(Age = 'Attained age (years)') %>%
            filter(Age >= 50)

female <- f_cohort %>% 
            rename(Age = 'Attained age (years)') %>%
            filter(Age >= 50)

# Replace rownames with values from Age row
rownames(male) <- male$Age
rownames(female) <- female$Age
male <- subset(male, select = -Age)
female <- subset(female, select = -Age)

# Add prefix to colnames so we can reference them with $ operator
#colnames(male) <- paste("y", colnames(male), sep = '')
#colnames(female) <- paste("y", colnames(female), sep = '')

# Scale all values to the 2012 column
male_norm <- male / male[,32]
female_norm <- female / female[,32]

# Take the inverse (we want lower values to represent reduced mortality)
m_inv <- 1 / male_norm
f_inv <- 2 / female_norm

m_inv


```

This is much more like it I think. We now have a value of 1 for all ages in the year 2012, which decreases into the future (reduced chance of mortality), and older years show an increase (where mortlity used to be higher). 

The next step now is to rearrange the matrices into a single table with 4 columns: gender, age, year, and adjustment (the latter column must be unnamed to be recognised by the model). We can do this by reshaping the data, which should then create multiple rows, one for each gender, age, and year combination.

```{r}
# Copy dfs so we don't have to rerun other chunks
m_copy <- m_inv
f_copy <- f_inv

# Add a column for gender and reinsert the rownames back as a column for reshaping
m_copy <- cbind(Male = 1, rownames(m_copy), m_copy)
rownames(m_copy) <- 1:nrow(m_copy)
f_copy <- cbind(Male = 0, rownames(f_copy), f_copy)
rownames(f_copy) <- 1:nrow(f_copy)
# Rename age column
m_copy <- rename(m_copy, Age = "rownames(m_copy)")
f_copy <- rename(f_copy, Age = "rownames(f_copy)")

# First attempt at reshaping with gather
m_long <- gather(m_copy, year, adjustment, 3:ncol(m_long), factor_key = TRUE)
# Looks good!

```





























