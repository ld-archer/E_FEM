---
title: "Generate Mortality Adjustment for FEM"
output: html_notebook
author: Luke Archer
email: l.archer@leeds.ac.uk
---

This notebook will go through the steps taken to generate the mortality adjustment table for the FEM.

The mortality adjustment is a table that specifies how the mortality rate should be adjusted over time in the FEM. As a rule, the mortality rate is decreasing over time. The original US version divided the mortality adjustment into a rate for those aged below 65, and those aged above. As the data we are using contains information by gender and single year of age, we will instead attempt to make a version of this with a separate rate by gender and single year of age.

```{r setup, include = FALSE}

# Need to set up the environment
workingDir <- "/home/luke/Documents/E_FEM_clean/E_FEM/"
knitr::opts_knit$set(root.dir = workingDir)

require(tidyverse)
require(readODS)
require(ggplot2)

```


First read in the .xls document containing the life tables. The life tables are divided into period and cohort tables, which are further subdivided by gender, resulting in 4 separate life tables.

```{r}
# Read in male and female, cohort and period data separately 
m_period <- read_ods('../Mortality_Projections/engppp18ex.ods',
                     sheet = 3,
                     skip = 9,
                     row_names = TRUE)
f_period <- read_ods('../Mortality_Projections/engppp18ex.ods',
                     sheet = 4,
                     skip = 9,
                     row_names = TRUE)
m_cohort <- read_ods('../Mortality_Projections/engppp18ex.ods',
                     sheet = 5,
                     skip = 9,
                     row_names = FALSE)
f_cohort <- read_ods('../Mortality_Projections/engppp18ex.ods',
                     sheet = 6,
                     skip = 9,
                     row_names = FALSE)

# First row is empty so remove
m_period <- m_period[-1,]
f_period <- f_period[-1,]
m_cohort <- m_cohort[-1,]
f_cohort <- f_cohort[-1,]
```

Steps:

- Drop ages below 50
- Assign age to rownames and drop Age column. End up with a matrix indexed by age and year.
- Normalise matrix to 2012 values (column 32)
- Calculate inverse (value < 1 == decreased chance of mortality)


```{r}
# Rename age column and filter out ages below 50
male <- m_cohort %>% 
            rename(age = 'Attained age (years)') %>%
            filter(age >= 50)

female <- f_cohort %>% 
            rename(age = 'Attained age (years)') %>%
            filter(age >= 50)

# Replace rownames with values from Age row
rownames(male) <- male$age
rownames(female) <- female$age
male <- subset(male, select = -age)
female <- subset(female, select = -age)

# Scale all values to the 2012 column
male_norm <- male / male[,32]
female_norm <- female / female[,32]

head(female_norm)

# Take the inverse (we want lower values to represent reduced mortality)
m_inv <- 1 / male_norm
f_inv <- 1 / female_norm

head(f_inv)
```

We now have a value of 1 for all ages in the year 2012, which decreases into the future (reduced chance of mortality), and previous years show an increase (where mortality used to be higher). 

The next step is to rearrange the matrices into a single table with 4 columns: gender, age, year, and adjustment (the latter column must be unnamed to be recognised by the model). We can do this with tidyr::gather.

```{r}
# Copy dfs so we don't have to rerun other chunks
m_copy <- m_inv
f_copy <- f_inv

# Add a column for gender and reinsert the rownames back as a column for reshaping
m_copy <- cbind(male = 1, rownames(m_copy), m_copy)
rownames(m_copy) <- 1:nrow(m_copy)
f_copy <- cbind(male = 0, rownames(f_copy), f_copy)
rownames(f_copy) <- 1:nrow(f_copy)
# Rename age column
m_copy <- rename(m_copy, age = "rownames(m_copy)")
f_copy <- rename(f_copy, age = "rownames(f_copy)")

# First attempt at reshaping with gather
m_long <- gather(m_copy, year, adjustment, 3:ncol(m_copy), factor_key = TRUE)
f_long <- gather(f_copy, year, adjustment, 3:ncol(f_copy), factor_key = TRUE)

head(f_long) # Looks good!
```

Last step is just to row bind and stick everything together, then can manually delete the 'adjustment' column heading before adding to a folder called 'mortality_adj_ELSA' in FEM_CPP_settings.

```{r}
# Combine male and female data
adjustment <- rbind(m_long, f_long)

head(adjustment)

# Write to folder outside trunk so we can't accidentally replace it later
write_tsv(adjustment, path = '/home/luke/Documents/E_FEM_clean/Mortality_Projections/mortality_adj.txt', 
                      append = FALSE, 
                      col_names = TRUE)
```

# DISREGARD ALL THE ABOVE

It's all wrong. Start again but can reuse some of the code for another dataset.

# Second Attempt Using Mortality Rates (qx)

```{r}
m_period <- read_ods('../Mortality_Projections/engppp18qx.ods',
                     sheet = 3,
                     skip = 6,
                     row_names = TRUE)
f_period <- read_ods('../Mortality_Projections/engppp18qx.ods',
                     sheet = 4,
                     skip = 6,
                     row_names = TRUE)
m_cohort <- read_ods('../Mortality_Projections/engppp18qx.ods',
                     sheet = 5,
                     skip = 6,
                     row_names = FALSE)
f_cohort <- read_ods('../Mortality_Projections/engppp18qx.ods',
                     sheet = 6,
                     skip = 6,
                     row_names = FALSE)

```

Steps:

- Drop ages below 50
- Assign age to rownames and drop Age column. End up with a matrix indexed by age and year.
- Calculate ratio between values for consecutive years

```{r}
# Rename age column and filter out ages below 50
male <- m_cohort %>% 
            rename(age = 'age (years)') %>%
            filter(age >= 50)

female <- f_cohort %>% 
            rename(age = 'age (years)') %>%
            filter(age >= 50)

# Replace rownames with values from Age row
rownames(male) <- male$age
rownames(female) <- female$age
male <- subset(male, select = -age)
female <- subset(female, select = -age)

ratio_df <- data.frame(matrix(vector(mode = 'numeric', length = nrow(male) * ncol(male)), nrow = nrow(male), ncol = ncol(male)))

for(i in nrow(male)) {
  for(j in ncol(male)) {
    ratio_df[i,j] <- male[i,j] / male[i-1, j-1]
  }
}


```


```{r}
# Rename age column and filter out ages below 50
male <- m_cohort %>% 
            rename(age = 'age (years)') %>%
            filter(age >= 50)

female <- f_cohort %>% 
            rename(age = 'age (years)') %>%
            filter(age >= 50)

# Replace rownames with values from Age row
rownames(male) <- male$age
rownames(female) <- female$age
male <- subset(male, select = -age)
female <- subset(female, select = -age)

# Scale all values to the 2012 column
# SET TO 2004 FOR TESTING AGAINST US, NEED TO CHANGE THIS BACK 
male_norm <- male / male[,24]
female_norm <- female / female[,24]

head(female_norm)
```


```{r}
# Copy dfs so we don't have to rerun other chunks
m_copy <- male_norm
f_copy <- female_norm

# Add a column for gender and reinsert the rownames back as a column for reshaping
m_copy <- cbind(male = 1, rownames(m_copy), m_copy)
rownames(m_copy) <- 1:nrow(m_copy)
f_copy <- cbind(male = 0, rownames(f_copy), f_copy)
rownames(f_copy) <- 1:nrow(f_copy)
# Rename age column
m_copy <- rename(m_copy, age = "rownames(m_copy)")
f_copy <- rename(f_copy, age = "rownames(f_copy)")

# First attempt at reshaping with gather
m_long <- gather(m_copy, year, adjustment, 3:ncol(m_copy), factor_key = TRUE)
f_long <- gather(f_copy, year, adjustment, 3:ncol(f_copy), factor_key = TRUE)

head(f_long) # Looks good!
```

Write out the file to E_FEM_clean/Mortality_Projections/.

```{r}
# Combine male and female data
adjustment <- rbind(m_long, f_long)

head(adjustment)

# Write to folder outside trunk so we can't accidentally replace it later
write_tsv(adjustment, path = '/home/luke/Documents/E_FEM_clean/Mortality_Projections/mortality_adj.txt', 
                      append = FALSE, 
                      col_names = TRUE)
```

```{r}
# Test against US data
us_adj <- read_tsv('../Mortality_Projections/mortality_adj_US.txt', col_names = TRUE, skip = 1)

adj <- adjustment

adj$year <- as.numeric(as.character(adj$year))
us_adj$year <- as.numeric(as.character(us_adj$year))

# Extract only 60 year olds from my dataset
# Drop all years before 1990 as this is when the US data starts
adj_60 <- adj %>%
                filter(age == 60) %>%
                select(-age) %>%
                filter(year > 1989) %>%
                rename(group = male)

# Drop all years after 2068 for US as this is when Eng data stops
# Also drop over 65 values
adj_us <- us_adj %>%
                filter(year < 2069) %>%
                filter(l2age65pd == 0) %>%
                rename(group = l2age65pd)
adj_us$group <- 2

```

NOW PLOT!!

```{r}

# Now combine the data and start plotting
combined <- rbind(adj_60, adj_us)

combined$group[combined$group == 1] <- 'male'
combined$group[combined$group == 0] <- 'female'
combined$group[combined$group == 2] <- 'US'

ggplot(data = combined, aes(x = year, y = adjustment, color = group)) +
      geom_line(size = 0.5) +
      labs(title = 'Age 60')


cut <- combined %>% filter(group != 'US')

ggplot(data = cut, aes(x = year, y = adjustment, color = group)) +
      geom_line()

cut2 <- cut %>% filter(group == 'female')

ggplot(data = cut2, aes(x = year, y = adjustment, color = group)) +
      geom_line()

```



```{r}
# Test against US data
us_adj2 <- read_tsv('../Mortality_Projections/mortality_adj_US.txt', col_names = TRUE, skip = 1)

adj2 <- adjustment

adj2$year <- as.numeric(as.character(adj2$year))
us_adj$year <- as.numeric(as.character(us_adj$year))
# Extract only 60 year olds from my dataset
# Drop all years before 1990 as this is when the US data starts
adj_60 <- adj2 %>%
                filter(age == 75) %>%
                select(-age) %>%
                filter(year > 1989) %>%
                rename(group = male)

# Drop all years after 2068 for US as this is when Eng data stops
# Also drop over 65 values
adj_us <- us_adj %>%
                filter(year < 2069) %>%
                filter(l2age65pd == 1) %>%
                rename(group = l2age65pd)
adj_us$group <- 2

```
```{r}

# Now combine the data and start plotting
combined <- rbind(adj_60, adj_us)

combined$group[combined$group == 1] <- 'male'
combined$group[combined$group == 0] <- 'female'
combined$group[combined$group == 2] <- 'US'

ggplot(data = combined, aes(x = year, y = adjustment, color = group)) +
      geom_line(size = 0.5) +
      labs(title = 'Age 75')


cut <- combined %>% filter(group != 'US')

ggplot(data = cut, aes(x = year, y = adjustment, color = group)) +
      geom_line()

cut2 <- cut %>% filter(group == 'female')

ggplot(data = cut2, aes(x = year, y = adjustment, color = group)) +
      geom_line()

```


















